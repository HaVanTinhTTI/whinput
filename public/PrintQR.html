<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Create Schedule Receipt (RWH-SCRAP)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f9f9f9;
    }
    h1 { text-align: center; }
    textarea {
      width: 100%; height: 100px; margin-bottom: 10px;
      color: #999;
    }
    textarea:focus { color: #000; }
    button {
      margin-top: 10px;
      padding: 8px 15px;
      cursor: pointer;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
    }
    button:hover { background: #0056b3; }
    #result, #summary {
      margin-top: 15px;
      white-space: pre-line;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    th { background: #eee; }
  </style>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <h1>Create Schedule Receipt (RWH - SCRAP)</h1>

  <p>D√°n d·ªØ li·ªáu t·ª´ Excel (c·ªôt: OrgName, form_no, ItemCode, team):</p>
  <textarea id="excelInput" placeholder="üìò V√≠ d·ª• d·ªØ li·ªáu m·∫´u (OrgName, form_no, ItemCode, team):

OrgName	form_no	ItemCode	team
TC2	MRCD24045307	900211001	DC
TC2	MRCD24045308	900211002	DC
TC5	MRCD24084278	900211003	DC
TC5	MRCD24084277	900211004	CC"></textarea><br>

  <button id="createBtn">Create Schedule Receipt</button>
  <button id="exportBtn" style="background:green;">Export Not Found</button>
  <div id="result"></div>
  <div id="summary"></div>

  <table id="dataTable">
    <thead>
      <tr>
        <th>OrgName</th>
        <th>Form No</th>
        <th>Item Code</th>
        <th>Team</th>
        <th>Status (K2_Master)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const supabaseUrl = 'https://chjqassbtcqthueeddou.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoanFhc3NidGNxdGh1ZWVkZG91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMzY2OTgsImV4cCI6MjA3NTcxMjY5OH0.FbWGSw9sqUkb2_ppErN4QTFGy1Cho-HX4XbR5_-KB0I';
    const client = supabase.createClient(supabaseUrl, supabaseKey);

    document.getElementById('createBtn').addEventListener('click', processData);

    async function processData() {
      const input = document.getElementById('excelInput').value.trim();
      const resultDiv = document.getElementById('result');
      const summaryDiv = document.getElementById('summary');
      const tableBody = document.querySelector('#dataTable tbody');
      tableBody.innerHTML = '';
      resultDiv.textContent = '';
      summaryDiv.textContent = '';

      if (!input) {
        alert('‚ö†Ô∏è Vui l√≤ng d√°n d·ªØ li·ªáu t·ª´ Excel (OrgName, form_no, ItemCode, team)');
        return;
      }

      // üîπ Parse d·ªØ li·ªáu t·ª´ Excel
      const lines = input.split('\n').filter(line => line.trim());
      const data = [];
      const invalid = [];

      lines.forEach((line, i) => {
        const parts = line.split(/\t|,|\|{1,}| {2,}/).map(p => p.trim()).filter(Boolean);
        if (parts.length < 4) {
          invalid.push(`D√≤ng ${i + 1}: "${line}"`);
          return;
        }
        const [OrgName, form_no, ItemCode, team] = parts;
        data.push({ OrgName, form_no, ItemCode, team });
      });

      if (invalid.length > 0) {
        resultDiv.textContent = `‚ùå ${invalid.length} d√≤ng l·ªói:\n${invalid.join('\n')}`;
        return;
      }

      // üî∏ Ki·ªÉm tra trong K2_Master (ch·ªâ theo OrgName + form_no + ItemCode)
      const matchResults = [];
      let matchedCount = 0;

      for (const row of data) {
        const { OrgName, form_no, ItemCode } = row;
        const { data: found, error } = await client
          .from('K2_Master')
          .select('form_no, "ItemCode", "OrgName"')
          .eq('form_no', form_no)
          .eq('ItemCode', ItemCode)
          .eq('OrgName', OrgName)
          .limit(1);

        const matched = found && found.length > 0;
        if (matched) matchedCount++;
        matchResults.push({ ...row, status: matched ? '‚úÖ Found' : '‚ùå Not Found' });
      }

      // üßæ Hi·ªÉn th·ªã b·∫£ng summary
      // üßæ Hi·ªÉn th·ªã b·∫£ng ch·ªâ ch·ª©a d√≤ng ‚ùå Not Found
const notFoundRows = matchResults.filter(r => r.status === '‚ùå Not Found');
notFoundRows.forEach(r => {
  const rowHTML = `
    <tr>
      <td>${r.OrgName}</td>
      <td>${r.form_no}</td>
      <td>${r.ItemCode}</td>
      <td>${r.team}</td>
      <td style="color:red">${r.status}</td>
    </tr>`;
  tableBody.insertAdjacentHTML('beforeend', rowHTML);
});


      summaryDiv.textContent = `üîç T·ªïng s·ªë d√≤ng: ${data.length}\n‚úÖ Kh·ªõp v·ªõi K2_Master: ${matchedCount}\n‚ùå Kh√¥ng kh·ªõp: ${data.length - matchedCount}`;

      // ‚öôÔ∏è Insert d·ªØ li·ªáu v√†o printed_qr_logs (4 c·ªôt + timestamp)
      // ‚öôÔ∏è Insert d·ªØ li·ªáu v√†o printed_qr_logs (4 c·ªôt + timestamp)
const insertData = data.map(d => ({
  OrgName: d.OrgName,
  form_no: d.form_no,
  ItemCode: d.ItemCode,
  team: d.team,
  printed_at: new Date().toISOString()
}));

const { error: insertErr } = await client
  .from('printed_qr_logs')
  .insert(insertData);

if (insertErr) {
  console.error("‚ùå L·ªói khi insert Supabase:", insertErr);
  alert('‚ùå L·ªói khi l∆∞u v√†o Supabase: ' + insertErr.message);
} else {
  alert(`‚úÖ ƒê√£ insert ${insertData.length} d√≤ng v√†o printed_qr_logs`);
}


     
    }
  </script>
</body>
</html>
