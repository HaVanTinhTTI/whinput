<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>RYOBI - RWH - SCRAP (Login + Tool)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--bg:#f7f7f9;--card:#fff;--bd:#e5e7eb;--muted:#6b7280;--pri:#2563eb;--pri2:#1d4ed8}
    *{box-sizing:border-box}
    body{font-family:Arial,sans-serif;padding:12px;background:var(--bg);color:#111}
    h1{text-align:center;margin:6px 0 12px}
    .tabs{display:flex;gap:8px;margin-bottom:10px;position:sticky;top:0;background:var(--bg);padding:6px 0;z-index:5}
    .tab{padding:10px 14px;border:1px solid var(--bd);border-radius:999px;cursor:pointer;background:#eef2ff}
    .tab.active{background:var(--pri);color:#fff;border-color:transparent}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .input{flex:1;min-width:200px;padding:10px;border:1px solid #cbd5e1;border-radius:8px;font-size:16px}
    .mini{width:140px}.mini-num{width:120px;text-align:center}
    .btn{padding:10px 14px;border:none;border-radius:8px;background:var(--pri);color:#fff;font-size:15px;cursor:pointer}
    .btn:hover{background:var(--pri2)}.btn-ghost{background:#e2e8f0;color:#111;border:none}
    .muted{color:var(--muted);font-size:13px}
    .ok{color:#16a34a}.warn{color:#b45309}.error{color:#dc2626}
    .table-wrap{overflow:auto;background:#fff;border:1px solid var(--bd);border-radius:10px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;text-align:center;border-bottom:1px solid #eee;white-space:nowrap}
    thead th{position:sticky;top:0;background:#f1f5f9;z-index:1}
    td[contenteditable="true"]{background:#fffbe6;cursor:text}
    .empty{text-align:center;color:#888;padding:20px}
    .footer{position:sticky;bottom:0;background:#fff;padding:10px;border:1px solid var(--bd);border-radius:10px;display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:10px}
    .pill{background:#eef2ff;padding:6px 10px;border-radius:999px;font-size:13px;display:inline-block}.pill+.pill{margin-left:6px}
    .section{display:none}.section.active{display:block}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px}
    .kpi{background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:12px;text-align:center}
    .kpi .v{font-size:22px;font-weight:700}.kpi .t{font-size:12px;color:#6b7280}
    .switch{display:inline-flex;align-items:center;gap:6px}.switch input{transform:scale(1.2)}
    .h-scroll{max-width:360px;overflow:auto;white-space:nowrap}
    @media(max-width:480px){.mini{width:48%}.mini-num{width:40%}.row .input{min-width:48%}}
    .hicons{display:inline-flex;gap:6px;align-items:center}
    .ico-btn{background:#e5e7eb;border-radius:6px;padding:2px 6px;font-size:12px;cursor:pointer;border:1px solid #d1d5db}
    .ico-btn:hover{background:#dbeafe}
	/* ‚ö° CLASS CHUNG CHO N√öT CH√çNH (Tab, Save, Upload) */
.btn-tab {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 10px 14px;
  border-radius: 10px;
  font-size: 15px;
  font-weight: 600;
  border: none;
  background: #f1f5f9;
  color: #1e293b;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: all 0.15s ease;
  cursor: pointer;
  flex: 1;
}

.btn-tab:hover {
  background: #e2e8f0;
}

.btn-tab.active {
  background: #2563eb;
  color: #fff;
}

.btn-tab:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* Bi·∫øn th·ªÉ m√†u (tu·ª≥ theo lo·∫°i thao t√°c) */
.btn-save {
  background: #22c55e;
  color: white;
}
.btn-upload {
  background: #0ea5e9;
  color: white;
}

	
	/* ===== MOBILE OPTIMIZE PATCH - v3.1 ===== */
@media (max-width: 768px) {
  body {
    padding: 10px;
    font-size: 15px;
  }

  .wrap {
    max-width: 480px;
    margin: 0 auto;
  }

  h1 {
    font-size: 18px;
    margin-bottom: 10px;
  }

  .card {
    padding: 10px;
    border-radius: 10px;
  }

  .input {
    font-size: 15px;
    padding: 10px 12px;
  }

  .btn {
    font-size: 15px;
    padding: 10px 12px;
    border-radius: 10px;
    width: 100%;
  }

  .row {
    flex-direction: column;
    align-items: stretch;
  }

  .btn-icon {
    width: 72px;

    height: 72px;
	}
	/* üé® MOBILE UI TINH G·ªåN */
body {
  background: #f8fafc;
  font-family: "Inter", sans-serif;
  font-size: 15px;
  margin: 0;
}

.container {
  max-width: 420px;
  margin: auto;
  padding: 10px;
}

/* Header */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 8px;
  background: #ffffff;
  border-bottom: 1px solid #e2e8f0;
  font-size: 15px;
  font-weight: 600;
  color: #334155;
}

/* User info */
header .user {
  font-size: 13px;
  font-weight: 500;
  color: #475569;
}


label, .input {
  display: block;
  width: 100%;
}

/* Button group small */
.btn-group {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin-top: 6px;
}
.btn {
  flex: 1;
  padding: 10px 0;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  border: none;
  cursor: pointer;
}
.btn-primary { background:#2563eb; color:white; }
.btn-secondary { background:#f1f5f9; color:#334155; }

/* Search bar */
.search-bar {
  display: flex;
  margin-top: 10px;
}
.search-bar input {
  flex: 1;
  padding: 10px;
  border: 1px solid #cbd5e1;
  border-radius: 8px 0 0 8px;
  outline: none;
  font-size: 15px;
}
.search-bar button {
  background:#2563eb;
  color:white;
  border:none;
  padding: 10px 16px;
  border-radius: 0 8px 8px 0;
  font-size: 15px;
  cursor:pointer;
}

/* Stats bar */
.stats-bar {
  display: flex;
  justify-content: space-around;
  align-items: center;
  background: #ffffff;
  border-radius: 12px;
  margin-top: 10px;
  padding: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  font-size: 14px;
}
.stats-bar div {
  text-align: center;
}



    #loginBox{
  display:flex;
  flex-direction:column;   /* x·∫øp d·ªçc */
  align-items:stretch;
  gap:10px;               /* kho·∫£ng c√°ch gi·ªØa c√°c d√≤ng */
}
#loginBox label{
  display:block;          /* label chi·∫øm nguy√™n d√≤ng */
  margin:6px 0 4px;
  color:#475569;
  font-size:14px;
  font-weight:500;
}
  #loginBox .input{
  display:block;          /* input chi·∫øm nguy√™n d√≤ng */
  width:100%;
  padding:12px;
  border:1px solid #cbd5e1;
  border-radius:10px;
  font-size:15px;
  box-sizing:border-box;
}
#loginBox label, #loginBox .input { display:block !important; width:100% !important; }
#btnLogin{
  width:100%;
  padding:12px;
  border-radius:10px;
}
  /* === HEADER (TOPBAR) === */
.topbar {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;

  background: #ffffff;
  border-bottom: 1px solid #e2e8f0;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);

  padding: 10px 12px;
  border-radius: 0 0 14px 14px;
}

.topbar .title {
  font-size: 18px;
  font-weight: 700;
  color: #1e293b;
  letter-spacing: 0.3px;
  margin-bottom: 6px;
}

.userbox {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  color: #334155;
}

.userbox .user-info {
  display: flex;
  align-items: center;
  gap: 4px;
  font-weight: 500;
}

.logout {
  border: none;
  background: #f1f5f9;
  color: #475569;
  padding: 4px 10px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
}

.logout:hover {
  background: #e2e8f0;
  color: #1e293b;
}

  /* === G·ªçn & C√¢n ƒë·ªÅu v√πng header n√∫t === */
.top-buttons {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
  margin-bottom: 6px;
}

.top-buttons button {
  flex: 1;
  min-width: 60px;
  height: 44px;              /* ‚ú® chu·∫©n chi·ªÅu cao ƒë·ªÅu */
  padding: 0;
  font-size: 14px;
  font-weight: 600;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: #2563eb;
  color: white;
  transition: background 0.2s ease;
}

.top-buttons button.secondary {
  background: #f1f5f9;
  color: #334155;
}
.top-buttons button:hover {
  background: #1e40af;
}

/* === Icon + text nh·ªè g·ªçn === */
.top-buttons button i {
  font-size: 18px;
  margin-bottom: 2px;
}
.top-buttons button span {
  font-size: 11px;
  line-height: 1;
}

/* === G·ªçn kho·∫£ng tr·∫Øng form === */
.form-section {
  margin-top: 8px;
}
.form-section label {
  font-size: 13px;
  color: #475569;
  margin-bottom: 3px;
}
.form-section input,
.form-section select {
  height: 38px;
  font-size: 14px;
  padding: 6px 10px;
  border-radius: 8px;
  border: 1px solid #cbd5e1;
  box-sizing: border-box;
}

/* === B·∫£ng d·ªØ li·ªáu === */
.table-wrap {
  overflow-x: auto;
}
.table-wrap table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
.table-wrap th,
.table-wrap td {
  padding: 6px 4px;
  text-align:

  /* === Nh√≥m n√∫t top g·ªçn v√† ƒë·ªÅu === */
.top-buttons {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 4px;
  margin-bottom: 6px;
  flex-wrap: nowrap;
}

.top-buttons button {
  flex: 1;
  min-width: 50px;
  height: 30px;                 /* ‚ú® chi·ªÅu cao nh·ªè g·ªçn */
  font-size: 13px;
  font-weight: 600;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  background: #2563eb;
  color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 0;
  transition: all 0.2s ease-in-out;
}

.top-buttons button i {
  font-size: 17px;              /* icon nh·ªè h∆°n */
  margin-bottom: 1px;
}
.top-buttons button span {
  font-size: 10.5px;            /* text nh·ªè g·ªçn h∆°n */
  line-height: 1;
}

.top-buttons button.secondary {
  background: #e2e8f0;
  color: #334155;
}

.top-buttons button:hover {
  transform: scale(1.03);
}

/* N·∫øu PDA nh·ªè h∆°n 400px th√¨ chia 2 h√†ng */
@media (max-width: 400px) {
  .top-buttons {
    flex-wrap: wrap;
  }
  .top-buttons button {
    flex: 0 0 32%;
  }
}

/* === G·ªçn kho·∫£ng tr·∫Øng trong form === */
.form-section {
  margin-top: 6px;
}
.form-section label {
  font-size: 12.5px;
  color: #475569;
  margin-bottom: 2px;
}
.form-section input,
.form-section select {
  height: 20px;
  font-size: 13px;
  padding: 5px 8px;
  border-radius: 7px;
  border: 1px s

  /* üéØ Ch·ªâ √°p d·ª•ng cho b·∫£ng PACK */
#packTable {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

/* V√πng bao quanh b·∫£ng PACK ‚Äî cao v·ª´a 1 m√†n h√¨nh PDA (~5 inch) */

#sheet3 .table-wrap {
  max-height: 420px;           /* ‚ú® chi·ªÅu cao c·ªë ƒë·ªãnh (t·∫ßm 5 inch PDA) */
  overflow-y: auto;            /* Cho ph√©p cu·ªôn d·ªçc */
  overflow-x: auto;            /* Cho ph√©p cu·ªôn ngang khi c·∫ßn */
  border: 1px solid #d1d5db;
  border-radius: 10px;
  background: #fff;
  scroll-behavior: smooth;
}

/* C·∫£i thi·ªán hi·ªÉn th·ªã header c·ªë ƒë·ªãnh */
#packTable thead th {
  position: sticky;
  top: 0;
  background: #f8fafc;
  z-index: 2;
  box-shadow: 0 2px 3px rgba(0,0,0,0.05);
}

#sheet3 .table-wrap {
  max-height: 420px;
  overflow-y: auto;
  overflow-x: auto;
  border: 1px solid #d1d5db;
  border-radius: 10px;
  background: #fff;
  scroll-behavior: smooth;
}
.row {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.input.mini {
  width: 130px;
  padding: 6px 8px;
  font-size: 14px;
}

@media (max-width: 480px) {
  .row {
    flex-wrap: wrap;
  }
  .input.mini {
    flex: 1 1 45%; /* t·ª± xu·ªëng h√†ng khi m√†n h√¨nh h·∫πp */
  }
}

  </style>
</head>
<body>

  <!-- ============== LOGIN SCREEN ============== -->
  <section id="loginBox" class="card">
    <h1>ƒêƒÉng nh·∫≠p h·ªá th·ªëng</h1>
    <label>User:</label>
    <select id="userSelect" class="input">
      <option value="">-- Ch·ªçn user --</option>
      <option value="Tinh">Tinh</option>
      <option value="Trung">Trung</option>
      <option value="Lai">Lai</option>
      <option value="Mi">Mi</option>
    </select>

    <label for="passwordInput">Password:</label>
	
<input id="passwordInput" type="password" class="input" placeholder="Nh·∫≠p m·∫≠t kh·∫©u..." />

    <button id="btnLogin" class="btn">üîë ƒêƒÉng nh·∫≠p</button>
    <p class="muted" id="loginMsg" style="margin-top:8px;"></p>
  </section>

  <!-- ============== MAIN TOOL ============== -->
  <section id="mainTool">
    <div class="topbar">
  <div class="title">üì¶ RYOBI ‚Äì RWH ‚Äì SCRAP (Mobile)</div>

  <div class="userbox">
    <span class="user-info">üë§ <b id="loginUser">Tinh</b></span>
    <button id="btnLogout" class="logout">ƒêƒÉng xu·∫•t</button>
  </div>
</div>


    <div class="tabs">
      <button class="tab active" data-tab="sheet1">üßæ Nh·∫≠n h√†ng</button>
      <button class="tab" data-tab="sheet2">üìä T·∫£i l√™n</button>
	   <button class="tab" data-tab="sheet3">üì¶ ƒê√≥ng g√≥i (Pack)</button>
	  <button id="btnSave" class="btn">üíæ L∆∞u t·∫°m</button>
       <button id="btnUpload" class="btn">‚òÅÔ∏è Upload</button>
	   <button id="btnLoad" class="btn">üîé T√¨m ki·∫øm</button>
    </div>

    <section id="sheet1" class="section active">
      <div class="card">
        <div class="row">
          <button id="btnSyncIn" class="btn-ghost">üì• T·∫£i d·ªØ li·ªáu v·ªÅ m√°y</button>
          <button id="btnViewCache" class="btn-ghost">üìö Xem cache</button>
          <div class="switch" title="B·∫≠t = t·ª± upload ngay sau L∆∞u t·∫°m (n·∫øu c√≥ m·∫°ng)">
            <input type="checkbox" id="chkAutoUpload">
            <label for="chkAutoUpload">Auto-Upload</label>
          </div>
        </div>
        <div id="syncMsg" class="muted" style="margin-top:6px;">Ch∆∞a t·∫£i d·ªØ li·ªáu.</div>
      </div>

      <div class="card">
        <div class="row">
          <input id="formNoInput" class="input" placeholder="Nh·∫≠p / scan Form No (ƒë·ªÉ tr·ªëng = xem t·∫•t c·∫£)" list="formList" />
          <datalist id="formList"></datalist>
          
		  
		  <div class="row" style="margin-top:8px;">
		  
		  <label>Th·ªùi gian in:</label>
		  <select id="selPrintedAt" class="input mini">
			<option value="">-- t·∫•t c·∫£ --</option>
		  </select>
		  <button id="btnFilterPrinted" class="btn-ghost">üïí L·ªçc theo th·ªùi gian in</button>
		</div>
		  
        </div>
        <div class="row" style="margin-top:8px;">
          
          </select>
          <label>Team:</label>
          <input id="inpTeam" class="input mini" placeholder="Nh·∫≠p team..." />
          
          
        </div>
      </div>

      <div class="table-wrap">
        <table id="table">
          <thead>
            <tr>
              <th>#</th>
              <th>
                <div class="hicons">
				  <span id="hiToggleSelect" class="ico-btn" title="Ch·ªçn/B·ªè ch·ªçn t·∫•t c·∫£">‚úì Select</span>
				</div>
              </th>
               
              <th>ItemCode</th>
              
              <th>Remaining Qty</th>
              <th>EHS VN Desc</th>
			  <th>Form No</th>
				<th>Qty form</th>
              <th>EHS Type</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="8" class="empty">Ch∆∞a c√≥ d·ªØ li·ªáu. B·∫•m ‚ÄúT√¨m ki·∫øm‚Äù.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="footer">
        <div>
          <span class="pill">Form: <b id="metaForm">-</b></span>
          <span class="pill">S·ªë form: <b id="metaFormCount">0</b></span>
          <span class="pill">D√≤ng: <b id="metaRows">0</b></span>
          <span class="pill">Ch·ªçn: <b id="metaSel">0</b></span>
		  
        </div>
        <div id="status" class="muted">üïì ƒêang ch·ªù thao t√°c...</div>
      </div>
    </section>

    <section id="sheet2" class="section">
      <div class="kpis">
        <div class="kpi"><div class="v" id="kpiCacheForms">0</div><div class="t">Form trong Cache</div></div>
        <div class="kpi"><div class="v" id="kpiCacheRows">0</div><div class="t">D√≤ng trong Cache</div></div>
        <div class="kpi"><div class="v" id="kpiDraftBatches">0</div><div class="t">L·∫ßn L∆∞u t·∫°m</div></div>
        <div class="kpi"><div class="v" id="kpiDraftItems">0</div><div class="t">B·∫£n ghi ch·ªù Upload</div></div>
        <div class="kpi"><div class="v" id="kpiAutoUpload">OFF</div><div class="t">Auto-Upload</div></div>
      </div>

      <div class="card" style="margin-top:10px;">
        <div class="row" style="justify-content:space-between;">
          <div class="muted" id="lastSyncTxt">L·∫ßn sync g·∫ßn nh·∫•t: -</div>
          <div class="row">
            <button id="btnUploadFromDash" class="btn">‚òÅÔ∏è Upload t·∫•t c·∫£</button>
            <button id="btnClearDrafts" class="btn-ghost">üßπ X√≥a drafts</button>
            <button id="btnClearCache" class="btn-ghost">üóëÔ∏è X√≥a cache</button>
          </div>
        </div>
        <div class="table-wrap" style="margin-top:8px;">
          <table>
            <thead><tr><th>#Batch</th><th>Saved at</th><th>S·ªë d√≤ng</th><th>Actions</th></tr></thead>
            <tbody id="draftBody"><tr><td colspan="4" class="empty">Ch∆∞a c√≥ d·ªØ li·ªáu L∆∞u t·∫°m.</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>
	
	
	<section id="sheet3" class="section">
  <div class="card">
    <div class="row">
      <label for="packBatch">Batch Scrap:</label>
      <select id="packBatch" class="input mini">
        <option value="">‚è≥ ƒêang t·∫£i...</option>
      </select>

      
      
	  <button id="btnPackAction" class="btn">‚ñ∂Ô∏è Th·ª±c hi·ªán Pack</button>

      <span id="packMsg" class="muted">Ch∆∞a t·∫£i d·ªØ li·ªáu.</span>
    </div>
  </div>

<!-- Filter theo Team + Pallet Mode (c√πng h√†ng) -->
<div class="row" style="margin-top:6px; align-items:center; flex-wrap:wrap; gap:8px;">
  <label for="filterTeamPack">üë• Team:</label>
  <select id="filterTeamPack" class="input mini">
    <option value="">-- L·ªçc theo Team --</option>
  </select>

  <label for="palletMode">üéØ Pallet:</label>
  <select id="palletMode" class="input mini">
    <option value="new">üÜï M·ªõi</option>
    <option value="exist">üì¶ C√≥ s·∫µn</option>
  </select>

  <select id="existPalletList" class="input mini">
    <option value="">-- Danh s√°ch Pallet --</option>
  </select>

  <!-- üîπ Hi·ªÉn th·ªã Pallet ID m·ªõi ngay b√™n c·∫°nh -->
  <span id="previewPalletID"
        style="font-weight:bold; color:#2563eb; font-size:13px; white-space:nowrap;">
  </span>
</div>




  <div class="table-wrap">
    <table id="packTable">
      <thead>
        <tr>
          <th>#</th>
          <th><button id="btnPackSelectAll" class="btn-ghost">‚úì</button>All</th>
		  
          <th>Form No</th>
          <th>ItemCode</th>
          <th>Quantity</th>
          <th>Status</th>
		  <th>Team</th>
        </tr>
      </thead>
      <tbody id="packTbody">
        <tr><td colspan="6" class="empty">Ch∆∞a c√≥ d·ªØ li·ªáu.</td></tr>
      </tbody>
    </table>
  </div>

  <div class="footer">
    <div>
      <span class="pill">D√≤ng: <b id="packMetaRows">0</b></span>
      <span class="pill">Ch·ªçn: <b id="packMetaSel">0</b></span>
    </div>
    <div id="packStatus" class="muted">üïì ƒêang ch·ªù thao t√°c...</div>
  </div>
</section>


	
	
	
</section>

	
	
	
  </section>

<script>
/* ========== LOGIN ========== */

const USERS = { "Tinh":"1234", "Trung":"abcd", "Lai":"1234", "Mi":"1234" };
const loginBox = document.getElementById('loginBox');
const mainTool = document.getElementById('mainTool');
const userSelect = document.getElementById('userSelect');
const passwordInput = document.getElementById('passwordInput');
const loginMsg = document.getElementById('loginMsg');
const loginUserEl = document.getElementById('loginUser');
const btnLogout = document.getElementById('btnLogout');

function getLoginUser(){ return localStorage.getItem('wh_user') || null; }
function showTool(user){ loginBox.style.display='none'; mainTool.style.display='block'; loginUserEl.textContent=user; }
function showLogin(){ loginBox.style.display='block'; mainTool.style.display='none'; userSelect.value=''; passwordInput.value=''; }

document.getElementById('btnLogin').addEventListener('click', ()=>{
  const u=userSelect.value.trim(), p=passwordInput.value.trim();
  if(!u){ loginMsg.textContent='‚ö†Ô∏è Vui l√≤ng ch·ªçn user.'; return; }
  if(!p){ loginMsg.textContent='‚ö†Ô∏è Nh·∫≠p m·∫≠t kh·∫©u.'; return; }
  if(USERS[u] && USERS[u]===p){ localStorage.setItem('wh_user',u); showTool(u); }
  else loginMsg.textContent='‚ùå Sai user ho·∫∑c m·∫≠t kh·∫©u.';
});
btnLogout.addEventListener('click', ()=>{ if(confirm('ƒêƒÉng xu·∫•t?')){ localStorage.removeItem('wh_user'); showLogin(); }});
localStorage.removeItem('wh_user');
showLogin();


/* ========== Supabase & constants (GI·ªÆ NGUY√äN B·∫¢N CH√çNH) ========== */
const supabaseUrl = 'https://chjqassbtcqthueeddou.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoanFhc3NidGNxdGh1ZWVkZG91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMzY2OTgsImV4cCI6MjA3NTcxMjY5OH0.FbWGSw9sqUkb2_ppErN4QTFGy1Cho-HX4XbR5_-KB0I';
const client = supabase.createClient(supabaseUrl, supabaseKey);

(async () => {
  const { data, error } = await client
    .from('Receipt_logs')
    .select('id, remaining_qty')
    .limit(1);

  if (error) {
    console.error('‚ö†Ô∏è REST schema ch∆∞a c·∫≠p nh·∫≠t:', error.message);
  } else {
    console.log('‚úÖ REST schema OK:', data);
  }
})();



const SOURCE_TABLE  = 'K2_Master';
const SOURCE_FIELDS = 'id,form_no,ItemCode,Quantity,"Remaining Qty",EHS_VN_description,EHS_Type,printed_at,receipt_date_time';
const RECEIPT_TABLE = 'Receipt_logs';

const LS_CACHE   = 'cache_k2_master_test';
const LS_DRAFTS  = 'drafts_k2_receipt';
const LS_LASTSYNC= 'cache_k2_last_sync';
const LS_AUTOUPL = 'receipt_autoupload';

/* ========== (M·ªöI) MAP C·ªòT Receipt_logs (th√™m received_by) ========== */
const RECEIPT_SCHEMA = 'k2style';
const RECEIPT_MAPS = {
  k2style: {
    id: 'id',
    remaining_qty: 'remaining_qty',   // ‚úÖ ƒê√∫ng t√™n th·ª±c t·∫ø trong DB
    team: 'team',
    created_at: 'created_at',
    received_by: 'received_by'
  },
  snake: {
    id: 'id',
    remaining_qty: 'remaining_qty',   // ‚úÖ t∆∞∆°ng t·ª±
    team: 'team',
    created_at: 'created_at',
    received_by: 'received_by'
  }
};

const COL = RECEIPT_MAPS[RECEIPT_SCHEMA];

/* ========== Elements (ID gi·ªØ nguy√™n) ========== */
const syncMsg      = document.getElementById('syncMsg');
const formNoInput  = document.getElementById('formNoInput');
const formList     = document.getElementById('formList');
const tbody        = document.getElementById('tbody');
const statusEl     = document.getElementById('status');
const metaForm     = document.getElementById('metaForm');
const metaFormCount= document.getElementById('metaFormCount');
const metaRows     = document.getElementById('metaRows');
const metaSel      = document.getElementById('metaSel');
const selType      = document.getElementById('selType');
const inpTeam      = document.getElementById('inpTeam');
const inpPalletCnt = document.getElementById('inpPalletCount');
const inpPalletStart = document.getElementById('inpPalletStart');
const chkAutoUpload= document.getElementById('chkAutoUpload');
//const hiSelectAll  = document.getElementById('hiSelectAll');
//const hiClearAll   = document.getElementById('hiClearAll');
const hiToggleSelect = document.getElementById('hiToggleSelect');

hiToggleSelect.addEventListener('click', () => {
  const total = currentRows.length;
  const selected = currentRows.filter(r => r.selected).length;
  const selectAll = selected < total; // n·∫øu ch∆∞a ch·ªçn h·∫øt th√¨ ch·ªçn h·∫øt

  currentRows.forEach(r => r.selected = selectAll);
  renderTable();
  updateMeta(currentRows, currentForms);

  // ƒê·ªïi text c·ªßa n√∫t cho tr·ª±c quan
  hiToggleSelect.textContent = selectAll ? '‚úï Clear' : '‚úì Select';
});
const kpiCacheForms= document.getElementById('kpiCacheForms');
const kpiCacheRows = document.getElementById('kpiCacheRows');
const kpiDraftBatches=document.getElementById('kpiDraftBatches');
const kpiDraftItems= document.getElementById('kpiDraftItems');
const kpiAutoUpload= document.getElementById('kpiAutoUpload');
const draftBody    = document.getElementById('draftBody');
const lastSyncTxt  = document.getElementById('lastSyncTxt');

/* ========== State ========== */
let currentRows = [];
let currentForms = [];
let seqCounter = 0;

/* ========== Helpers ========== */
const nowISO = ()=>{ const n=new Date(); n.setHours(n.getHours()+7); return n.toISOString(); };
function nowVNString(){ const n=new Date(); n.setHours(n.getHours()+7); return n.toISOString().replace('T',' ').replace('Z','').slice(0,19); }
function setCache(map){ localStorage.setItem(LS_CACHE, JSON.stringify(map||{})); }
function getCache(){ try{ return JSON.parse(localStorage.getItem(LS_CACHE)||'{}'); }catch{ return {}; } }
function getDrafts(){ try{ return JSON.parse(localStorage.getItem(LS_DRAFTS)||'[]'); }catch{ return []; } }
function setDrafts(arr){ localStorage.setItem(LS_DRAFTS, JSON.stringify(arr||[])); }
function setLastSync(){ localStorage.setItem(LS_LASTSYNC, nowISO()); }
function getLastSync(){ return localStorage.getItem(LS_LASTSYNC) || '-'; }
function refreshFormSuggestions(){ const forms=Object.keys(getCache()).sort(); formList.innerHTML=forms.map(fn=>`<option value="${fn}"></option>`).join(''); }
function makeRowKey(r){ return [r.form_no,r.ItemCode,r.Quantity,r.EHS_Type,r.EHS_VN_description].map(x=>String(x??'')).join('|'); }

/* ========== Dashboard Refresh ========== */
function refreshDashboard(){
  const cache=getCache(); const forms=Object.keys(cache);
  const rowsCount=forms.reduce((a,f)=>a+(cache[f]?.length||0),0);
  const drafts=getDrafts();
  const draftItems=drafts.reduce((a,b)=>a+((b.items||[]).length),0);
  kpiCacheForms.textContent=forms.length;
  kpiCacheRows.textContent=rowsCount;
  kpiDraftBatches.textContent=drafts.length;
  kpiDraftItems.textContent=draftItems;
  kpiAutoUpload.textContent=isAutoUploadOn()?'ON':'OFF';
  lastSyncTxt.textContent='L·∫ßn sync g·∫ßn nh·∫•t: '+getLastSync();

  if(drafts.length===0){
    draftBody.innerHTML = `<tr><td colspan="4" class="empty">Ch∆∞a c√≥ d·ªØ li·ªáu L∆∞u t·∫°m.</td></tr>`;
  }else{
    draftBody.innerHTML='';
    drafts.forEach((d,idx)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${idx+1}</td><td>${d.saved_at}</td><td>${(d.items||[]).length}</td>
        <td><button class="btn-ghost" data-act="uploadOne" data-idx="${idx}">‚òÅÔ∏è Upload</button>
            <button class="btn-ghost" data-act="delOne" data-idx="${idx}">üóëÔ∏è X√≥a</button></td>`;
      draftBody.appendChild(tr);
    });
    draftBody.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const idx=+btn.dataset.idx; const act=btn.dataset.act;
        if(act==='delOne'){ const d=getDrafts(); d.splice(idx,1); setDrafts(d); refreshDashboard(); }
        else if(act==='uploadOne'){ await uploadDraftIndex(idx); refreshDashboard(); }
      });
    });
  }
}

/* ========== Tabs ========== */
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.getElementById(btn.dataset.tab).classList.add('active');
    if(btn.dataset.tab==='sheet2') refreshDashboard();
  });
});



/* ========== Auto-Upload ========== */
function isAutoUploadOn(){ return localStorage.getItem(LS_AUTOUPL)==='1'; }
function setAutoUpload(on){ localStorage.setItem(LS_AUTOUPL,on?'1':'0'); chkAutoUpload.checked=on; kpiAutoUpload.textContent=on?'ON':'OFF'; }
chkAutoUpload.addEventListener('change', ()=> setAutoUpload(chkAutoUpload.checked));
setAutoUpload(isAutoUploadOn());

/* ========== 1) Sync In ========== */

document.getElementById('btnSyncIn').addEventListener('click', async ()=>{
  syncMsg.textContent = '‚è≥ ƒêang t·∫£i d·ªØ li·ªáu t·ª´ K2_Master...';
  try{
    const { data, error } = await client
      .from(SOURCE_TABLE)
      .select(SOURCE_FIELDS)
      .not('printed_at','is',null)
      .is('receipt_date_time',null);
    if(error) throw error;

    // üü¢ L·ªçc th√™m: ch·ªâ l·∫•y Remaining Qty > 0
    const filtered = (data || []).filter(r => Number(r["Remaining Qty"]) > 0);
	// üîπ G√°n id t·∫°m cho d√≤ng thi·∫øu id t·ª´ K2
filtered.forEach((r, idx) => {
  if (!r.id || r.id === null) {
    r.id = `K2TEMP_${Date.now()}_${idx}`;
  }
});
    if(!filtered.length){
      setCache({}); setLastSync();
      syncMsg.innerHTML = '<span class="warn">‚ö†Ô∏è Kh√¥ng c√≥ d√≤ng n√†o th·ªèa ƒëi·ªÅu ki·ªán.</span>';
      refreshFormSuggestions(); refreshDashboard(); return;
    }

    const map={};
    filtered.forEach(r=>{
      if(!map[r.form_no]) map[r.form_no]=[];
      r._key = makeRowKey(r);
      map[r.form_no].push(r);
    });

    setCache(map); setLastSync();
	
		// üü° Sau khi t·∫£i cache, t·∫°o dropdown printed_at unique
	const allPrinted = [...new Set(filtered.map(r => (r.printed_at || '').slice(0,19)))].sort();
	const selPrintedAt = document.getElementById('selPrintedAt');
	selPrintedAt.innerHTML = `<option value="">-- t·∫•t c·∫£ (${allPrinted.length}) --</option>` +
	  allPrinted.map(p => `<option value="${p}">${p}</option>`).join('');

	
	
    syncMsg.innerHTML = `<span class="ok">‚úÖ ƒê√£ t·∫£i ${Object.keys(map).length} form_no (Remaining > 0).</span>`;
    refreshFormSuggestions(); refreshDashboard();
  }catch(err){
    console.error(err);
    syncMsg.innerHTML = `<span class="error">‚ùå L·ªói t·∫£i d·ªØ li·ªáu: ${err.message||err}</span>`;
  }
});




document.getElementById('btnViewCache').addEventListener('click', ()=>{
  const cache=getCache(); const forms=Object.keys(cache);
  const rows=forms.reduce((a,f)=>a+(cache[f]?.length||0),0);
  alert(forms.length?`üìö Cache: ${forms.length} form_no, ${rows} d√≤ng.`:'üì≠ Cache tr·ªëng.');
});

/* ========== 2) T√¨m ki·∫øm (tr·ªëng = t·∫•t c·∫£) + autocomplete ========== */
formNoInput.addEventListener('input', ()=>{
  const cache=getCache(); 
  const q=formNoInput.value.trim().toUpperCase();
  const forms=Object.keys(cache)
    .filter(fn=>!q||fn.toUpperCase().includes(q))
    .slice(0,200);
  formList.innerHTML=forms.map(fn=>`<option value="${fn}"></option>`).join('');

  // üü¢ Khi ch·ªçn ho·∫∑c g√µ ƒë·ªß Form No, t·ª± ƒë·ªông load lu√¥n
  if(q && forms.includes(q)) {
    document.getElementById('btnLoad').click();
  }
});

document.getElementById('btnLoad').addEventListener('click', ()=>{
  const cache=getCache(); const q=formNoInput.value.trim(); let rows=[];
  if(!q){ Object.keys(cache).forEach(fn=>(cache[fn]||[]).forEach(r=>rows.push(r))); currentForms=Object.keys(cache); }
  else { rows=cache[q]||[]; currentForms=rows.length?[q]:[]; }

  if(!rows.length){
    tbody.innerHTML=`<tr><td colspan="8" class="empty">${q?`Kh√¥ng t√¨m th·∫•y Form No: ${q}`:'Cache tr·ªëng. H√£y b·∫•m ‚ÄúT·∫£i d·ªØ li·ªáu v·ªÅ m√°y‚Äù.'}</td></tr>`;
    updateMeta([],[]); return;
  }

  rows.forEach(r=>{ if(!r._key) r._key=makeRowKey(r); });
  rows.sort((a,b)=> String(a.ItemCode).localeCompare(String(b.ItemCode),'en',{numeric:true}));
  seqCounter=0;
  currentRows=rows.map(r=>({...r,seq:++seqCounter,selected:false}));
  renderTable(); updateMeta(currentRows,currentForms);
  statusEl.textContent=`‚úÖ T·∫£i ${currentRows.length} d√≤ng (${currentForms.length} form)`;
  
  // üü¢ TH√äM ƒêO·∫†N N√ÄY ·ªû CU·ªêI H√ÄM
  const allPrinted = [...new Set(currentRows.map(r => (r.printed_at || '').slice(0,19)))].sort();
  document.getElementById('selPrintedAt').innerHTML =
    `<option value="">-- t·∫•t c·∫£ (${allPrinted.length}) --</option>` +
    allPrinted.map(p => `<option value="${p}">${p}</option>`).join('');
});

formNoInput.addEventListener('keydown', e=>{ if(e.key==='Enter') document.getElementById('btnLoad').click(); });



// ========== L·ªçc theo printed_at (unique) ==========
document.getElementById('btnFilterPrinted').addEventListener('click', ()=>{
  const selVal = document.getElementById('selPrintedAt').value;
  const cache = getCache();
  const forms = Object.keys(cache);
  let rows = [];

  forms.forEach(fn=>{
    (cache[fn]||[]).forEach(r=>{
      if(!selVal || (r.printed_at && r.printed_at.startsWith(selVal))) rows.push(r);
    });
  });

  if(!rows.length){
    tbody.innerHTML = `<tr><td colspan="8" class="empty">‚ö†Ô∏è Kh√¥ng c√≥ d√≤ng n√†o c√≥ printed_at = ${selVal || '(t·∫•t c·∫£)'}.</td></tr>`;
    updateMeta([],[]);
    return;
  }

  rows.sort((a,b)=> String(a.ItemCode).localeCompare(String(b.ItemCode),'en',{numeric:true}));
  seqCounter = 0;
  currentRows = rows.map(r=>({...r, seq:++seqCounter, selected:false}));
  renderTable(); updateMeta(currentRows, forms);
  statusEl.textContent = `‚úÖ L·ªçc ${currentRows.length} d√≤ng (printed_at = ${selVal || 't·∫•t c·∫£'})`;
});



/* ========== Render + Bind ========== */
function renderTable(){
  tbody.innerHTML='';
  if(!currentRows.length){ tbody.innerHTML=`<tr><td colspan="8" class="empty">Danh s√°ch tr·ªëng.</td></tr>`; return; }
  currentRows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${r.seq}</td>
      <td><input type="checkbox" class="row-check" ${r.selected?'checked':''}></td>
      
      <td>${r.ItemCode??''}</td>
      
      <td contenteditable="true">${r["Remaining Qty"]??''}</td>
      <td class="h-scroll">${r.EHS_VN_description??''}</td>
	  <td>${r.form_no??''}</td>
	  <td>${r.Quantity??''}</td>
      <td>${r.EHS_Type??''}</td>`;
    tbody.appendChild(tr);
  });
  bindEvents();
  
  hiToggleSelect.textContent = '‚úì Select';

}
function bindEvents(){
  tbody.querySelectorAll('.row-check').forEach((cb,i)=>{
    cb.addEventListener('change', e=>{ currentRows[i].selected=e.target.checked; updateMeta(currentRows,currentForms); });
  });
  tbody.querySelectorAll('td[contenteditable="true"]').forEach((cell,i)=>{
    cell.addEventListener('input', e=>{
      const val=e.target.innerText.trim();
      currentRows[i]["Remaining Qty"]=val;
      const cache=getCache(); const f=currentRows[i].form_no;
      if(cache[f]){
        const idx=cache[f].findIndex(x=> (x._key||makeRowKey(x))===currentRows[i]._key);
        if(idx>-1){ cache[f][idx]["Remaining Qty"]=val; setCache(cache); }
      }
    });
  });
}
//hiSelectAll.addEventListener('click', ()=>{ currentRows.forEach(r=>r.selected=true); renderTable(); updateMeta(currentRows,currentForms); });
//hiClearAll.addEventListener('click', ()=>{ currentRows.forEach(r=>r.selected=false); renderTable(); updateMeta(currentRows,currentForms); });

/* ========== Meta footer ========== */
function updateMeta(rows,forms){
  metaForm.textContent=(forms.length===0)?'-':(forms.length===1?forms[0]:'T·∫•t c·∫£');
  metaFormCount.textContent=forms.length;
  metaRows.textContent=rows.length;
  metaSel.textContent=rows.filter(r=>r.selected).length;
}


/* ========== L∆∞u t·∫°m (nh√¢n theo pallet) ========== */

// ========== L∆∞u t·∫°m (ƒë∆°n gi·∫£n h√≥a kh√¥ng d√πng validateHeader) ==========
document.getElementById('btnSave').addEventListener('click', async ()=>{
  const picked = currentRows.filter(r => r.selected);
  if (!picked.length) return alert('‚ö†Ô∏è Ch∆∞a ch·ªçn d√≤ng n√†o.');

  const team = inpTeam.value.trim();
  if (!team) return alert('‚ö†Ô∏è Ch∆∞a nh·∫≠p Team.');

  const records = [];
  for (const r of picked) {
    const rem = (r["Remaining Qty"] ?? '').toString().trim();
 let rid = r.id ?? r.ID ?? null;
if (!rid) rid = `K2TEMP_${Date.now()}_${Math.floor(Math.random()*1000)}`;


records.push({
  id: Number(String(r.id).trim()),
  remaining_qty: rem === '' ? null : Number(rem),
  team: team,
  created_at: nowVNString(),
  status: 'pending'
});


 
 
 
  }

  const drafts = getDrafts();
  drafts.push({ saved_at: nowISO(), items: records });
  setDrafts(drafts);

  removePickedFromUIAndCache(picked);
  statusEl.textContent = `üíæ L∆∞u t·∫°m ${records.length} b·∫£n ghi & ƒë√£ lo·∫°i kh·ªèi danh s√°ch.`;
  refreshDashboard();

  if (isAutoUploadOn() && navigator.onLine) {
    await uploadAllDrafts();
    refreshDashboard();
    statusEl.textContent = '‚òÅÔ∏è Auto-Upload xong.';
  }
});




function removePickedFromUIAndCache(picked){
  const keys=new Set(picked.map(p=>p._key));
  currentRows=currentRows.filter(r=>!keys.has(r._key));
  currentRows.forEach((r,i)=>r.seq=i+1);
  renderTable(); updateMeta(currentRows,currentForms);

  const cache=getCache();
  Object.keys(cache).forEach(fn=>{
    cache[fn]=(cache[fn]||[]).filter(r=>(r._key||makeRowKey(r))&&!keys.has(r._key||makeRowKey(r)));
    if(cache[fn].length===0) delete cache[fn];
  });
  setCache(cache); refreshFormSuggestions();
}

/* ========== Upload helpers (Final Clean) ========== */
function _chunk(arr,size){ const out=[]; for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size)); return out; }

// Chu·∫©n h√≥a base ‚Äî ch√®n received_by = user ƒëƒÉng nh·∫≠p (ho·∫∑c 'system' n·∫øu ch∆∞a c√≥)

function _normalizeBase(x){
  const remRaw = x.remaining_qty ?? x["Remaining Qty"] ?? null;
  const remNum = remRaw === null || remRaw === '' ? null : Number(remRaw);
  return {
    id: x.id ?? x.ID ?? null,
    remaining_qty: remNum,   // ‚úÖ √©p sang numeric
    team: x.team ?? null,
    created_at: x.created_at ?? nowVNString(),
    received_by: getLoginUser() || 'system'
  };
}



// Map sang t√™n c·ªôt th·ª±c t·∫ø tr√™n Receipt_logs (ƒë√É th√™m received_by)


function _toDbRow(x){
  const r = _normalizeBase(x);
  return {
    [COL.id]: r.id,
    [COL.remaining_qty]: r.remaining_qty,  // ‚úÖ ƒê√öNG C·ªòT TRONG DB
    [COL.team]: r.team,
    [COL.created_at]: r.created_at,
    [COL.received_by]: r.received_by
  };
}


// Ch·ªâ cho ph√©p c√°c c·ªôt n√†y (kh·ªõp t√™n th·ª±c trong DB)
const ALLOWED_RECEIPT_COLUMNS = [
  'id','remaining_qty','type','team','created_at','received_by'
];

function sanitizePayload(items){
  return items.map(obj=>{
    const clean={};
    for(const k of ALLOWED_RECEIPT_COLUMNS){
      if(Object.prototype.hasOwnProperty.call(obj,k)) clean[k]=obj[k];
    }
    return clean;
  });
}

const DEBUG_UPLOAD=true;

async function uploadReceiptLogs(items){
  if(!Array.isArray(items)||items.length===0) return {ok:true,inserted:0};
  const payload=sanitizePayload(items.map(_toDbRow));

  let batchSize=500, inserted=0, lastErr=null;
  while(batchSize>=50){
    try{
      const batches=_chunk(payload,batchSize);
      for(const b of batches){
        const opts={ returning: DEBUG_UPLOAD ? 'representation' : 'minimal' };
        const { error, status } = await client.from(RECEIPT_TABLE).insert(b,opts);
        if(error){ if(DEBUG_UPLOAD) console.error('Receipt_logs insert error:',{status,error,batchSize,sample:b[0]}); throw error; }
        if(DEBUG_UPLOAD) console.log('Inserted batch:',{status,count:b.length});
        inserted+=b.length;
      }
      return {ok:true,inserted};
    }catch(e){
      console.warn('uploadReceiptLogs batchSize',batchSize,'error:',e?.message||e);
      lastErr=e; batchSize=Math.floor(batchSize/2);
    }
  }
  throw new Error(`Upload Receipt_logs th·∫•t b·∫°i sau nhi·ªÅu l·∫ßn th·ª≠: ${lastErr?.message||lastErr}`);
}

async function uploadAllDrafts(){
  const drafts=getDrafts(); if(!drafts.length) return {success:0,fail:0};
  const allItems=drafts.flatMap(d=>d.items||[]); if(!allItems.length) return {success:0,fail:0};
  try{
    const res=await uploadReceiptLogs(allItems);
    if(res.ok){ setDrafts([]); statusEl.textContent=`‚òÅÔ∏è Upload Receipt_logs: ${res.inserted} b·∫£n ghi OK.`; return {success:res.inserted,fail:0}; }
    else { statusEl.textContent='‚ùå Upload l·ªói (kh√¥ng r√µ).'; return {success:0,fail:allItems.length}; }
  }catch(e){
    console.error('Upload Receipt_logs l·ªói:',e);
    alert('Upload l·ªói: '+(e.message||e));
    statusEl.textContent=`‚ùå Upload l·ªói: ${e.message||e}`;
    return {success:0,fail:allItems.length};
  }
}

async function uploadDraftIndex(idx){
  const drafts=getDrafts(); const d=drafts[idx]; if(!d) return;
  const items=(d.items||[]); if(!items.length) return;
  try{
    const res=await uploadReceiptLogs(items);
    if(res.ok){ drafts.splice(idx,1); setDrafts(drafts); statusEl.textContent=`‚òÅÔ∏è Upload batch #${idx+1} OK (${res.inserted}).`; }
    else{ statusEl.textContent=`‚ùå Upload batch #${idx+1} l·ªói.`; }
  }catch(e){ console.error(e); alert('Upload l·ªói: '+(e.message||e)); }
}

/* ========== Upload th·ªß c√¥ng & Dashboard buttons ========== */
document.getElementById('btnUpload').addEventListener('click', async ()=>{
  if(!navigator.onLine) return alert('Kh√¥ng c√≥ m·∫°ng.');
  if(!getDrafts().length) return alert('Kh√¥ng c√≥ d·ªØ li·ªáu l∆∞u t·∫°m.');
  await uploadAllDrafts(); refreshDashboard();
  currentRows=[]; renderTable(); updateMeta(currentRows,currentForms);
});
document.getElementById('btnUploadFromDash').addEventListener('click', async ()=>{
  if(!navigator.onLine) return alert('Kh√¥ng c√≥ m·∫°ng.');
  if(!getDrafts().length) return alert('Kh√¥ng c√≥ d·ªØ li·ªáu l∆∞u t·∫°m.');
  await uploadAllDrafts(); refreshDashboard();
});
document.getElementById('btnClearDrafts').addEventListener('click', ()=>{
  if(confirm('X√≥a t·∫•t c·∫£ drafts l∆∞u t·∫°m?')){ setDrafts([]); refreshDashboard(); }
});
document.getElementById('btnClearCache').addEventListener('click', ()=>{
  if(confirm('X√≥a to√†n b·ªô cache?')){ setCache({}); refreshFormSuggestions(); refreshDashboard(); }
});



/* ========== üì¶ PACKING (STEP 1) ========== */
const PACK_TABLE = 'K2_Master';
const PACK_FIELDS = 'id,form_no,ItemCode,qty_receipt,status,team';
const packTbody = document.getElementById('packTbody');
const packMsg = document.getElementById('packMsg');
const packMetaRows = document.getElementById('packMetaRows');
const packMetaSel = document.getElementById('packMetaSel');
const packStatus = document.getElementById('packStatus');

let packRowsAll = []; // d·ªØ li·ªáu g·ªëc t·ª´ DB
let packRows = [];    // d·ªØ li·ªáu hi·ªÉn th·ªã (sau filter)


/* üß© Load danh s√°ch team (ƒë·ªÉ filter sau n√†y) */
async function loadFilterTeamOptions() {
  try {
    const { data, error } = await client
      .from(PACK_TABLE)
      .select(PACK_FIELDS)
      .ilike('status', '%waiting pack%');
    if (error) throw error;

    const uniqueTeams = [...new Set(data.map(r => (r.team || '').trim()))]
      .filter(Boolean)
      .sort();

    const sel = document.getElementById('filterTeamPack');
    sel.innerHTML = `<option value="">-- T·∫•t c·∫£ Team (${uniqueTeams.length}) --</option>` +
      uniqueTeams.map(t => `<option value="${t}">${t}</option>`).join('');

  } catch (err) {
    console.error('‚ùå L·ªói load Team Filter:', err.message);
  }
}

/* üß© Load batch active */
const packBatchSel = document.getElementById('packBatch');
async function loadActiveBatchList() {
  try {
    packBatchSel.innerHTML = `<option value="">‚è≥ ƒêang t·∫£i Batch...</option>`;
    const { data, error } = await client
      .from('Batch_Master')
      .select('batch_scrap')
      .eq('status', 'active')
      .order('batch_scrap', { ascending: false });
    if (error) throw error;

    if (!data?.length) {
      packBatchSel.innerHTML = `<option value="">‚ö†Ô∏è Kh√¥ng c√≥ batch active.</option>`;
      return;
    }
    packBatchSel.innerHTML = data.map((r, i) =>
      `<option value="${r.batch_scrap}" ${i === 0 ? 'selected' : ''}>${r.batch_scrap}</option>`
    ).join('');
  } catch (err) {
    console.error('‚ùå L·ªói load batch:', err.message);
    packBatchSel.innerHTML = `<option value="">‚ùå L·ªói t·∫£i batch</option>`;
  }
}

/* üß© T·∫£i danh s√°ch ch·ªù pack */





/* üß© Render b·∫£ng pack */
function renderPackTable() {
  packTbody.innerHTML = '';
  if (!packRows.length) {
    packTbody.innerHTML = `<tr><td colspan="7" class="empty">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>`;
    updatePackMeta();
    return;
  }

  packRows.forEach((r, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.seq}</td>
      <td><input type="checkbox" class="pack-check" ${r.selected ? 'checked' : ''}></td>
      <td>${r.form_no ?? ''}</td>
      <td>${r.ItemCode ?? ''}</td>
      <td contenteditable="true" class="editable-qty" data-index="${i}">${r.qty_receipt ?? ''}</td>
      <td>${r.status ?? ''}</td>
      <td>${r.team ?? ''}</td>
    `;
    packTbody.appendChild(tr);
  });

  packTbody.querySelectorAll('.pack-check').forEach((cb, i) => {
    cb.addEventListener('change', e => {
      packRows[i].selected = e.target.checked;
      updatePackMeta();
    });
  });

  packTbody.querySelectorAll('.editable-qty').forEach(cell => {
    cell.addEventListener('input', e => {
      const idx = +e.target.dataset.index;
      const val = e.target.innerText.trim();
      packRows[idx].qty_receipt = val === '' ? null : Number(val);
      e.target.style.background = '#fff8dc';
    });
  });

  updatePackMeta();
}

/* üß© Meta hi·ªÉn th·ªã */
function updatePackMeta() {
  packMetaRows.textContent = packRows.length;
  packMetaSel.textContent = packRows.filter(r => r.selected).length;
}


// üîç L·ªçc danh s√°ch Pack theo Team ƒë∆∞·ª£c ch·ªçn

document.getElementById('filterTeamPack').addEventListener('change', (e) => {
  const selectedTeam = e.target.value.trim();

  if (!selectedTeam) {
    packRows = [...packRowsAll]; // üîÅ tr·∫£ v·ªÅ to√†n b·ªô
    renderPackTable();
    packStatus.textContent = "üëÄ Hi·ªÉn th·ªã to√†n b·ªô danh s√°ch Waiting pack.";
    return;
  }

  // üîç L·ªçc d·ª±a tr√™n packRowsAll (d·ªØ li·ªáu g·ªëc)
  packRows = packRowsAll.filter(r =>
    String(r.team || '').toLowerCase() === selectedTeam.toLowerCase()
  );

  renderPackTable();
  packStatus.textContent = `‚úÖ L·ªçc ${packRows.length} d√≤ng thu·ªôc team: ${selectedTeam}`;
});



/* üß© N√∫t ch·ªçn t·∫•t c·∫£ */
document.getElementById('btnPackSelectAll').addEventListener('click', () => {
  const allSelected = packRows.every(r => r.selected);
  packRows.forEach(r => (r.selected = !allSelected));
  renderPackTable();
});
const palletModeSel = document.getElementById('palletMode');
const existPalletList = document.getElementById('existPalletList');

/* üß© Load danh s√°ch pallet ƒëang c√≥ cho tu·∫ßn hi·ªán t·∫°i */
async function loadExistingPallets(currentWeekTag) {
  try {
    existPalletList.innerHTML = `<option value="">‚è≥ ƒêang t·∫£i...</option>`;
    const { data, error } = await client
      .from('summary_pack_log')
      .select('pallet_id')
      .ilike('pallet_id', `${currentWeekTag}-%`);

    if (error) throw error;

    if (!data?.length) {
      existPalletList.innerHTML = `<option value="">‚ö†Ô∏è Kh√¥ng c√≥ pallet n√†o tu·∫ßn ${currentWeekTag}</option>`;
      return;
    }

    // L·∫•y danh s√°ch duy nh·∫•t v√† s·∫Øp theo s·ªë th·ª© t·ª±
    const unique = [...new Set(data.map(r => r.pallet_id))].sort();
    existPalletList.innerHTML =
      `<option value="">-- Ch·ªçn pallet c√≥ s·∫µn (${unique.length}) --</option>` +
      unique.map(p => `<option value="${p}">${p}</option>`).join('');
  } catch (err) {
    console.error('‚ùå L·ªói load pallet:', err.message);
    existPalletList.innerHTML = `<option value="">‚ùå L·ªói t·∫£i pallet</option>`;
  }
}


// üß© C·∫≠p nh·∫≠t hi·ªÉn th·ªã Pallet ID m·ªõi / c√≥ s·∫µn

document.getElementById('palletMode').addEventListener('change', async () => {
  const palletMode = palletModeSel.value;
  const batchScrap = packBatchSel.value.trim();
  const selectedTeam = document.getElementById('filterTeamPack').value.trim();
  const preview = document.getElementById('previewPalletID');

  preview.textContent = '';

  if (!batchScrap) {
    preview.textContent = '‚ö†Ô∏è Ch·ªçn Batch tr∆∞·ªõc';
    preview.style.color = '#dc2626';
    return;
  }

  if (!selectedTeam) {
    preview.textContent = '‚ö†Ô∏è Ch·ªçn Team tr∆∞·ªõc';
    preview.style.color = '#dc2626';
    return;
  }

  // ‚úÖ L·∫•y tu·∫ßn hi·ªán t·∫°i (+7h)
  const now = new Date();
  now.setHours(now.getHours() + 7);
  function getISOWeek(d) {
    const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = date.getUTCDay() || 7;
    date.setUTCDate(date.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
    return Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
  }
  const weekTag = `W${String(getISOWeek(now)).padStart(2, '0')}`;

  if (palletMode === 'exist') {
    preview.textContent = '';
    preview.style.color = '';
    await loadExistingPallets(weekTag);
    return;
  }

  // üÜï Pallet m·ªõi ‚Äî c√≥ Team trong t√™n nh∆∞ng s·ªë ch·∫°y chung batch
  try {
    const palletPrefix = `${weekTag}-${batchScrap}`;
    
	
	// ‚úÖ L·∫•y pallet cu·ªëi t·ª´ pack_putaway_logs, kh√¥ng tr√πng l·∫∑p
const { data, error } = await client
  .from('pack_putaway_logs')
  .select('pallet_id')
  .ilike('pallet_id', `${palletPrefix}-%`);

if (error) throw error;

let nextSeq = 1;
if (data?.length) {
  const nums = data
    .map(r => parseInt(String(r.pallet_id || '').split('-').pop(), 10))
    .filter(n => Number.isInteger(n))
    .sort((a, b) => b - a);
  if (nums.length > 0) nextSeq = nums[0] + 1;
}


    const nextPalletID = `${palletPrefix}-${selectedTeam}-${String(nextSeq).padStart(3, '0')}`;

    preview.textContent = `üÜï ${nextPalletID}`;
    preview.style.color = '#2563eb';
  } catch (err) {
    preview.textContent = '‚ùå L·ªói t·∫°o pallet';
    preview.style.color = '#dc2626';
    console.error('‚ùå L·ªói khi t·∫°o pallet:', err.message);
  }
});



// üß† G·ª£i √Ω th√™m: n·∫øu user ƒë·ªïi team ho·∫∑c batch ‚Üí c·∫≠p nh·∫≠t preview l·∫°i
['filterTeamPack', 'packBatch'].forEach(id => {
  document.getElementById(id).addEventListener('change', () => {
    const mode = palletModeSel.value;
    if (mode === 'new') {
      document.getElementById('palletMode').dispatchEvent(new Event('change'));
    }
  });
});


/* üß© Th·ª±c hi·ªán pack ‚Äî s·ª≠a l·ªói double insert */

/* üß© Th·ª±c hi·ªán pack ‚Äî phi√™n b·∫£n FIX FULL */
document.getElementById('btnPackAction').addEventListener('click', async () => {
  const selected = packRows.filter(r => r.selected);
  const user = getLoginUser() || 'system';
  const batchScrap = document.getElementById('packBatch').value;
  const selectedTeam = document.getElementById('filterTeamPack').value.trim();

  if (!selected.length) return alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 d√≤ng ƒë·ªÉ Pack.');
  if (!batchScrap) return alert('‚ö†Ô∏è Ch∆∞a ch·ªçn Batch Scrap.');
  if (!selectedTeam) return alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn Team tr∆∞·ªõc khi Pack.');

  const palletMode = palletModeSel.value;
  const existPallet = existPalletList.value;

  // üîπ T√≠nh tu·∫ßn ISO (c√≥ +7h)
  const now = new Date();
  now.setHours(now.getHours() + 7);
  const weekTag = getCurrentWeekTag();
  const palletPrefix = `${weekTag}-${batchScrap}`;

  let palletBase = `${palletPrefix}-${selectedTeam}-001`;

  // ‚úÖ N·∫øu ch·ªçn pallet c√≥ s·∫µn
  if (palletMode === 'exist') {
    if (!existPallet) return alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn 1 pallet c√≥ s·∫µn.');
    palletBase = existPallet;
  } else {
    // ‚úÖ T·∫°o pallet m·ªõi theo s·ªë l·ªõn nh·∫•t trong pack_putaway_logs
    try {
      const { data, error } = await client
        .from('pack_putaway_logs')
        .select('pallet_id')
        .ilike('pallet_id', `${palletPrefix}-%`);
      if (error) throw error;

      let nextSeq = 1;
      if (data?.length) {
        const nums = data
          .map(r => parseInt(String(r.pallet_id || '').split('-').pop(), 10))
          .filter(n => Number.isInteger(n))
          .sort((a, b) => b - a);
        if (nums.length > 0) nextSeq = nums[0] + 1;
      }

      palletBase = `${palletPrefix}-${selectedTeam}-${String(nextSeq).padStart(3, '0')}`;
    } catch (err) {
      console.warn('‚ö†Ô∏è Kh√¥ng l·∫•y ƒë∆∞·ª£c pallet cu·ªëi:', err.message);
    }
  }

  const pack_time = now.toISOString();

  // üîπ Chu·∫©n b·ªã logs ghi pack
  const logs = selected.map(r => ({
    id: r.id,
    pallet_id: palletBase,
    qty: Number(r.qty_receipt) || 0,
    pack_time,
    pack_by: user
  }));

  try {
    // ‚úÖ Ghi log chi ti·∫øt
    const { error } = await client.from('pack_putaway_logs').insert(logs);
    if (error) throw error;

    // ‚úÖ Update list ch·ªù pack
    packRowsAll = packRowsAll.map(r => {
      const match = logs.find(l => l.id === r.id);
      if (!match) return r;
      const packed = Number(match.qty) || 0;
      const total = Number(r.qty_receipt) || 0;
      return packed >= total ? null : { ...r, qty_receipt: total - packed, selected: false };
    }).filter(Boolean);

    // ‚úÖ L·ªçc theo team (n·∫øu c√≥)
    packRows = selectedTeam
      ? packRowsAll.filter(r => String(r.team || '').toLowerCase() === selectedTeam.toLowerCase())
      : [...packRowsAll];

    renderPackTable();
    updatePackMeta();

    packStatus.textContent = `‚úÖ Pack ${logs.length} d√≤ng v√†o pallet ${palletBase}.`;
    alert(`‚úÖ Pack th√†nh c√¥ng ${logs.length} d√≤ng v√†o pallet ${palletBase}.`);

    // ‚úÖ Ghi nh·∫≠n pallet m·ªõi v√†o summary_pack_log (ƒë·ªÉ tracking)
    await client.from('summary_pack_log').insert({
      pallet_id: palletBase,
      created_at: new Date().toISOString(),
      pack_by: user,
      batch_scrap: batchScrap,
      week_tag: weekTag
    });

    // ‚úÖ C·∫≠p nh·∫≠t preview pallet m·ªõi k·∫ø ti·∫øp
    const { data } = await client
      .from('pack_putaway_logs')
      .select('pallet_id')
      .ilike('pallet_id', `${palletPrefix}-%`);

    let nextSeq = 1;
    if (data?.length) {
      const nums = data
        .map(r => parseInt(String(r.pallet_id || '').split('-').pop(), 10))
        .filter(n => Number.isInteger(n))
        .sort((a, b) => b - a);
      if (nums.length > 0) nextSeq = nums[0] + 1;
    }

    const nextPalletID = `${palletPrefix}-${selectedTeam}-${String(nextSeq).padStart(3, '0')}`;
    const preview = document.getElementById('previewPalletID');
    preview.textContent = `üÜï ${nextPalletID}`;
    preview.style.color = '#2563eb';

  } catch (err) {
    console.error('‚ùå L·ªói pack:', err);
    packStatus.textContent = '‚ùå L·ªói: ' + (err.message || err);
    alert('‚ùå L·ªói ghi log pack: ' + (err.message || err));
  }
});



async function generateNewPalletID() {
  const batchScrap = document.getElementById('packBatch').value;
  const selectedTeam = document.getElementById('filterTeamPack').value.trim() || 'TEAM';
  const weekTag = getCurrentWeekTag();
  const palletPrefix = `${weekTag}-${batchScrap}`;

  let nextSeq = 1;
  try {
    const { data, error } = await client
      .from('pack_putaway_logs')
      .select('pallet_id')
      .ilike('pallet_id', `${palletPrefix}-%`);

    if (error) throw error;

    if (data?.length) {
      const nums = data
        .map(r => parseInt(String(r.pallet_id || '').split('-').pop(), 10))
        .filter(n => Number.isInteger(n))
        .sort((a, b) => b - a);
      if (nums.length > 0) nextSeq = nums[0] + 1;
    }
  } catch (err) {
    console.warn('‚ö†Ô∏è Kh√¥ng th·ªÉ l·∫•y s·ªë pallet cu·ªëi:', err.message);
  }

  const nextPalletID = `${palletPrefix}-${selectedTeam}-${String(nextSeq).padStart(3, '0')}`;
  const preview = document.getElementById('previewPalletID');
  if (preview) {
    preview.textContent = `üÜï ${nextPalletID}`;
    preview.style.color = '#2563eb';
  }

  return nextPalletID;
}




// ‚úÖ H√†m t√≠nh tu·∫ßn hi·ªán t·∫°i (chu·∫©n ISO, c√≥ +7h)
function getCurrentWeekTag() {
  const now = new Date();
  now.setHours(now.getHours() + 7); // VN timezone
  const date = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()));
  const dayNum = date.getUTCDay() || 7;
  date.setUTCDate(date.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
  const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
  return `W${String(weekNo).padStart(2, '0')}`;
}



// Render l·∫°i b·∫£ng sau khi l·ªçc
renderPackTable();
updatePackMeta();
packStatus.textContent = "‚ôªÔ∏è ƒê√£ lo·∫°i b·ªè item pack ƒë·ªß, gi·ªØ l·∫°i item ch∆∞a ƒë·ªß ƒë·ªÉ pack ti·∫øp.";


/* üß© T·∫£i danh s√°ch Waiting Pack (th√™m m·ªõi) */
async function loadWaitingPack() {
  packMsg.textContent = "‚è≥ ƒêang t·∫£i danh s√°ch Waiting Pack...";
  packTbody.innerHTML = `<tr><td colspan="7" class="empty">‚è≥ ƒêang t·∫£i...</td></tr>`;

  try {
    const { data, error } = await client
      .from(PACK_TABLE)
      .select(PACK_FIELDS)
      .ilike('status', '%waiting pack%');

    if (error) throw error;

    if (!data?.length) {
      packTbody.innerHTML = `<tr><td colspan="7" class="empty">‚ö†Ô∏è Kh√¥ng c√≥ d√≤ng n√†o Waiting pack.</td></tr>`;
      packMsg.textContent = "Kh√¥ng c√≥ d·ªØ li·ªáu.";
      packRows = [];
      updatePackMeta();
      return;
    }

    // ‚úÖ Chu·∫©n h√≥a d·ªØ li·ªáu
	// ‚úÖ Chu·∫©n h√≥a d·ªØ li·ªáu g·ªëc
packRowsAll = data.map((r, i) => ({
  ...r,
  seq: i + 1,
  selected: false
}));

// ‚úÖ S·∫Øp x·∫øp ItemCode a‚Üíz
packRowsAll.sort((a, b) =>
  String(a.ItemCode || '').localeCompare(String(b.ItemCode || ''), 'en', { sensitivity: 'base', numeric: true })
);

// ‚úÖ G√°n b·∫£n sao cho hi·ªÉn th·ªã
packRows = [...packRowsAll];

renderPackTable();
packMsg.textContent = `‚úÖ ƒê√£ t·∫£i ${packRows.length} d√≤ng Waiting pack.`;



  } catch (err) {
    console.error("‚ùå L·ªói loadWaitingPack:", err);
    packMsg.textContent = `‚ùå L·ªói t·∫£i d·ªØ li·ªáu: ${err.message}`;
  }
}

/* üß© G·ªçi t·ª± ƒë·ªông khi m·ªü tab ho·∫∑c load trang */
async function initPackingModule() {
  await Promise.all([loadActiveBatchList(), loadFilterTeamOptions()]);
  await loadWaitingPack(); // t·ª± ƒë·ªông t·∫£i danh s√°ch
  
  
  
  // üîπ Sau khi load xong, t·ª± ƒë·ªông l·∫•y pallet tu·∫ßn hi·ªán t·∫°i
  const now = new Date();
  now.setHours(now.getHours() + 7);
  const weekTag = `W${String(Math.ceil((((new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate())) - new Date(Date.UTC(now.getFullYear(), 0, 1))) / 86400000) + 1) / 7)).padStart(2, '0')}`;
  await loadExistingPallets(weekTag);
  
}

/* Khi user m·ªü tab ‚Äúƒê√≥ng g√≥i (Pack)‚Äù th√¨ auto t·∫£i lu√¥n */
document.querySelector('[data-tab="sheet3"]').addEventListener('click', () => {
  initPackingModule();
});

/* L·∫ßn ƒë·∫ßu m·ªü trang */
initPackingModule();



/* kh·ªüi t·∫°o */

refreshFormSuggestions(); refreshDashboard();
</script>
	
</body>
</html>
