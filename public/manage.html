<div class="main-wrap">

  <!-- FILTER BAR -->
  <div id="filter-bar">
    <label>BU:
      <select id="filter-bu"><option value="">All</option></select>
    </label>

    <label>Weekly:
      <select id="filter-weekly"><option value="">All</option></select>
    </label>

    <label>Type:
      <select id="filter-type"><option value="">All</option></select>
    </label>

    <label>Team:
      <select id="filter-team"><option value="">All</option></select>
    </label>

    <label>From row:
      <input id="input-from" type="number" min="1" value="1"
        style="width:90px;padding:6px;border-radius:6px;border:1px solid #ccc" />
    </label>

    <label>Page size:
      <select id="page-size" style="padding:6px;border-radius:6px;border:1px solid #ccc">
        <option value="25">25</option>
        <option value="50" selected>50</option>
        <option value="100">100</option>
      </select>
    </label>

    <button id="btn-apply" class="btn-apply">Apply</button>
    <button id="btn-reset" class="btn-reset">Reset</button>
  </div>

  <!-- KPI -->
  <div class="kpi-row">
    <div class="kpi-box kpi-qty"><div class="label">Total Quantity</div><div id="kpi-quantity" class="value">0</div></div>
    <div class="kpi-box kpi-wt"><div class="label">Total Weight</div><div id="kpi-weight" class="value">0</div></div>
    <div class="kpi-box kpi-val"><div class="label">Total Value</div><div id="kpi-value" class="value">0</div></div>
    <div class="kpi-box kpi-item"><div class="label">Count of Item</div><div id="kpi-item" class="value">0</div></div>
  </div>

  <!-- CHART -->
  <div class="chart-wrap">
    <canvas id="chart" height="160"></canvas>
  </div>

  <!-- DETAIL TABLE -->
  <div class="table-wrap">
    <h3>Scrap Detail Data</h3>
    
    <div style="margin-bottom:10px; display:flex; gap:10px; justify-content:flex-end;">
      <button id="btn-export-page" class="btn-outline">ðŸ“„ Export Page</button>
      <button id="btn-export-all" class="btn-primary">ðŸ“¦ Export All</button>
    </div>
    
    <table>
      <thead>
        <tr><th>BU</th><th>Item Code</th><th>Quantity</th><th>Weight</th><th>Value</th></tr>
      </thead>
      <tbody id="detail-body"></tbody>
    </table>

    <div class="page-controls">
      <button id="btn-prev">Prev</button>
      <div class="page-info" id="page-info">Rows 0 - 0 / 0</div>
      <button id="btn-next">Next</button>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
import * as XLSX from "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/+esm";

const supabaseUrl = "https://chjqassbtcqthueeddou.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoanFhc3NidGNxdGh1ZWVkZG91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMzY2OTgsImV4cCI6MjA3NTcxMjY5OH0.FbWGSw9sqUkb2_ppErN4QTFGy1Cho-HX4XbR5_-KB0I";
const supabase = createClient(supabaseUrl, supabaseKey);

let chartInstance = null;
let currentCount = 0;
let currentPageData = [];

const escapeHtml = (s) => s==null?'':String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');

function getFiltersFromUI(){
  return {
    BU: document.getElementById('filter-bu').value || null,
    Weekly: document.getElementById('filter-weekly').value || null,
    Type: document.getElementById('filter-type').value || null,
    Team: document.getElementById('filter-team').value || null
  };
}

/* ---------- load filter options ---------- */
async function loadFilters(){
  const { data, error } = await supabase.from('vw_kpi_scrap_filters').select('*');
  if (error) return console.error(error);
  const buList = [...new Set(data.map(r=>r.BU).filter(Boolean))].sort();
  const weekList = [...new Set(data.map(r=>r.Weekly).filter(Boolean))].sort((a,b)=>a.localeCompare(b, undefined, {numeric:true}));
  const typeList = [...new Set(data.map(r=>r.Type).filter(Boolean))].sort();
  const teamList = [...new Set(data.map(r=>r.Team).filter(Boolean))].sort();

  const setOptions = (id, arr) => {
    document.getElementById(id).innerHTML =
      '<option value="">All</option>' +
      arr.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
  };
  setOptions('filter-bu', buList);
  setOptions('filter-weekly', weekList);
  setOptions('filter-type', typeList);
  setOptions('filter-team', teamList);
}

/* ---------- KPI ---------- */
async function loadKPIandChart(){
  const filters = getFiltersFromUI();
  let q = supabase.from('summary_scrap_weekly').select('*');
  if (filters.BU) q = q.eq('BU', filters.BU);
  if (filters.Weekly) q = q.eq('Weekly', filters.Weekly);
  if (filters.Type) q = q.eq('Type', filters.Type);
  if (filters.Team) q = q.eq('Team', filters.Team);

  const { data, error } = await q;
  if (error) return console.error(error);

  const arr = data || [];
  const totalQty = arr.reduce((s,r)=>s + Number(r.total_quantity || 0), 0);
  const totalWt = arr.reduce((s,r)=>s + Number(r.total_weight || 0), 0);
  const totalVal = arr.reduce((s,r)=>s + Number(r.total_value || 0), 0);
  const totalItems = arr.reduce((s,r)=>s + Number(r.total_items || 0), 0);

  document.getElementById('kpi-quantity').textContent = totalQty.toLocaleString();
  document.getElementById('kpi-weight').textContent = totalWt.toLocaleString();
  document.getElementById('kpi-value').textContent = totalVal.toLocaleString();
  document.getElementById('kpi-item').textContent = totalItems.toLocaleString();

  const sorted = arr.slice().sort((a,b)=>String(a.Weekly).localeCompare(String(b.Weekly), undefined, {numeric:true}));
  drawChart(sorted);
}

/* ---------- Chart ---------- */
function drawChart(data){
  const ctx = document.getElementById('chart').getContext('2d');
  const labels = data.map(r=>r.Weekly);
  const itemCount = data.map(r=>Number(r.total_items || 0));
  const weights = data.map(r=>Number(r.total_weight || 0));
  const values = data.map(r=>Number(r.total_value || 0));

  if (chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    data: {
      labels,
      datasets: [
        { type:'bar', label:'Item Count', data:itemCount, backgroundColor:'#4caf50' },
        { type:'bar', label:'Sum Weight', data:weights, backgroundColor:'#2196f3' },
        { type:'line', label:'Value', data:values, borderColor:'#ff5722', yAxisID:'y1', tension:0.2, fill:false }
      ]
    },
    options: {
      responsive:true,
      interaction:{ mode:'index', intersect:false },
      scales: {
        y: { beginAtZero:true },
        y1: { position:'right', grid:{ drawOnChartArea:false } }
      }
    }
  });
}

/* ---------- Detail ---------- */
async function loadDetail(){
  const filters = getFiltersFromUI();
  const from = parseInt(document.getElementById('input-from').value || '1', 10) - 1;
  const pageSize = parseInt(document.getElementById('page-size').value || '50', 10);
  let q = supabase.from('Detail_Scrap_Data').select('*', { count: 'exact' }).range(from, from+pageSize-1);

  if (filters.BU) q = q.eq('BU', filters.BU);
  if (filters.Weekly) q = q.eq('Weekly', filters.Weekly);
  if (filters.Type) q = q.eq('Type', filters.Type);
  if (filters.Team) q = q.eq('Team_deliver', filters.Team);

  const { data, count, error } = await q;
  if (error) return console.error(error);

  currentCount = count || 0;
  currentPageData = data || [];
  const allCols = data?.length ? Object.keys(data[0]) : ["No data"];
  const thead = `<tr>${allCols.map(c=>`<th>${escapeHtml(c)}</th>`).join('')}</tr>`;
  const tbody = data?.map(r => `<tr>${allCols.map(c=>`<td>${escapeHtml(r[c])}</td>`).join('')}</tr>`).join('') || '<tr><td colspan="100%">No rows</td></tr>';
  document.querySelector(".table-wrap thead").innerHTML = thead;
  document.getElementById('detail-body').innerHTML = tbody;
}

/* ---------- Event binding ---------- */
document.getElementById('btn-apply').addEventListener('click', async ()=>{await loadKPIandChart(); await loadDetail();});
document.getElementById('btn-reset').addEventListener('click', async ()=>{document.querySelectorAll('#filter-bu,#filter-weekly,#filter-type,#filter-team').forEach(e=>e.value=''); await loadKPIandChart(); await loadDetail();});
document.getElementById('btn-export-page').addEventListener('click', ()=>exportData(false));
document.getElementById('btn-export-all').addEventListener('click', ()=>exportData(true));

await loadFilters();
await loadKPIandChart();
await loadDetail();
</script>
