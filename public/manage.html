<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TTI Scrap Management</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ===== HEADER ===== */
.Header_Tieude {
  padding: 5px 0;
  margin: 0;
  font-family: Tahoma, sans-serif;
  font-size: 30px;
  color: white;
  height: 60px;
  background-color: #B5E61D;
  width: 100%;
  text-align: center;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  position: fixed;
  top: 0;
  left: 0;
  z-index: 1000;
}
.Header_Tieude .logo-left { height: 45px; position: absolute; left: 10px; }
.Header_Tieude .logo-right { height: 70px; position: absolute; right: 0px; }

/* ===== SIDEBAR ===== */
.sidebar {
  position: fixed;
  top: 60px;
  left: 0;
  width: 220px;
  height: calc(100% - 60px);
  background-color: #f4f4f4;
  border-right: 2px solid #ccc;
  padding: 20px;
  box-sizing: border-box;
  font-family: Tahoma, sans-serif;
  overflow-y: auto;
}

/* ===== MAIN ===== */
body { margin: 0; background:#f7f7f7; }
.main-wrap { margin-left: 240px; margin-top: 80px; padding: 18px; font-family: Tahoma, sans-serif; }

/* filter bar */
#filter-bar {
  display:flex;
  gap:12px;
  align-items:center;
  flex-wrap:wrap;
  background: #fff;
  padding:10px 14px;
  border-radius:8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.06);
}

/* KPI */
.kpi-row { display:flex; gap:16px; margin-top:14px; flex-wrap:wrap; }
.kpi-box { flex:1; min-width:180px; padding:16px; border-radius:8px; color:#fff; font-weight:700; }
.kpi-box .label { font-size:13px; font-weight:600; opacity:0.9 }
.kpi-box .value { font-size:26px; margin-top:6px }

/* colors */
.kpi-qty { background:#4caf50; }
.kpi-wt { background:#2196f3; }
.kpi-val { background:#ff9800; }
.kpi-item { background:#9c27b0; }

/* chart container */
.chart-wrap { margin-top:20px; background:#fff; padding:18px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.06); }

/* detail table */
.table-wrap { margin-top:18px; background:#fff; padding:14px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.06); }
.table-wrap table { width:100%; border-collapse: collapse; font-size:13px; }
.table-wrap th, .table-wrap td { border:1px solid #e3e3e3; padding:8px; text-align:center; }
.table-wrap th { background:#f4f4f4; }

/* pagination */
.page-controls { display:flex; gap:10px; align-items:center; justify-content:center; margin-top:10px; }
.page-controls button { padding:6px 10px; border-radius:6px; border:1px solid #ccc; background:#fff; cursor:pointer; }
.page-info { font-size:13px; color:#333; }

/* footer */
#footer-wrapper { width:100%; background-color:#f2f2f2; padding:10px 0; border-top:2px solid #ccc; text-align:left; position:fixed; bottom:0; left:0; }
.footercuahang { margin-left:10px; font-family:Tahoma, sans-serif; }
</style>
</head>
<body>

<!-- HEADER -->

<!-- MAIN -->
<div class="main-wrap">

  <!-- FILTER BAR (single source of truth) -->
  <div id="filter-bar">
    <label>BU:
      <select id="filter-bu"><option value="">All</option></select>
    </label>

    <label>Weekly:
      <select id="filter-weekly"><option value="">All</option></select>
    </label>

    <label>Type:
      <select id="filter-type"><option value="">All</option></select>
    </label>

    <label>Team:
      <select id="filter-team"><option value="">All</option></select>
    </label>

    <label>From row:
      <input id="input-from" type="number" min="1" value="1" style="width:90px;padding:6px;border-radius:6px;border:1px solid #ccc" />
    </label>

    <label>Page size:
      <select id="page-size" style="padding:6px;border-radius:6px;border:1px solid #ccc">
        <option value="25">25</option><option value="50" selected>50</option><option value="100">100</option>
      </select>
    </label>

    <button id="btn-apply" style="padding:8px 12px;border-radius:6px;border:none;background:#4caf50;color:#fff;cursor:pointer">Apply</button>
    <button id="btn-reset" style="padding:8px 12px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer">Reset</button>
  </div>

  <!-- KPI -->
  <div class="kpi-row">
    <div class="kpi-box kpi-qty"><div class="label">Total Quantity</div><div id="kpi-quantity" class="value">0</div></div>
    <div class="kpi-box kpi-wt"><div class="label">Total Weight</div><div id="kpi-weight" class="value">0</div></div>
    <div class="kpi-box kpi-val"><div class="label">Total Value</div><div id="kpi-value" class="value">0</div></div>
    <div class="kpi-box kpi-item"><div class="label">Count of Item</div><div id="kpi-item" class="value">0</div></div>
  </div>

  <!-- CHART -->
  <div class="chart-wrap">
    <canvas id="chart" height="160"></canvas>
  </div>

  <!-- DETAIL TABLE -->
  <div class="table-wrap">
    <h3>Scrap Detail Data</h3>
    
    <!-- Export buttons -->
    <div style="margin-bottom:10px; display:flex; gap:10px; justify-content:flex-end;">
      <button id="btn-export-page" style="padding:8px 12px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer;">üìÑ Export Page</button>
      <button id="btn-export-all" style="padding:8px 12px;border-radius:6px;border:none;background:#2196f3;color:#fff;cursor:pointer;">üì¶ Export All</button>
    </div>
    
    <table>
      <thead>
        <tr><th>BU</th><th>Item Code</th><th>Quantity</th><th>Weight</th><th>Value</th></tr>
      </thead>
      <tbody id="detail-body"></tbody>
    </table>

    <div class="page-controls">
      <button id="btn-prev">Prev</button>
      <div class="page-info" id="page-info">Rows 0 - 0 / 0</div>
      <button id="btn-next">Next</button>
    </div>
  </div>

</div>

<!-- FOOTER -->
<div id="footer-wrapper">
  <div class="footercuahang">
    <p style="font-size:1vw; margin: 0;">Contact: Ha Van Tinh (VN.OP-SC-WH) / Smile Dinh Thanh Trung (VN.OP-WH)</p>
  </div>
</div>

<!-- SCRIPT -->
<script type="module">
/* ---------- Supabase setup ---------- */
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
import * as XLSX from "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/+esm";

const supabaseUrl = "https://chjqassbtcqthueeddou.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoanFhc3NidGNxdGh1ZWVkZG91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMzY2OTgsImV4cCI6MjA3NTcxMjY5OH0.FbWGSw9sqUkb2_ppErN4QTFGy1Cho-HX4XbR5_-KB0I";
const supabase = createClient(supabaseUrl, supabaseKey);

/* ---------- state ---------- */
let chartInstance = null;
let currentCount = 0;
let lastQueryFilters = {};
let currentPageData = []; // L∆∞u tr·ªØ d·ªØ li·ªáu trang hi·ªán t·∫°i

/* ---------- helpers ---------- */
const escapeHtml = (s) => s==null?'':String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');

function getFiltersFromUI(){
  return {
    BU: document.getElementById('filter-bu').value || null,
    Weekly: document.getElementById('filter-weekly').value || null,
    Type: document.getElementById('filter-type').value || null,
    Team: document.getElementById('filter-team').value || null
  };
}

/* ---------- load filter options (from view) ---------- */
async function loadFilters(){
  try {
    const { data, error } = await supabase.from('vw_kpi_scrap_filters').select('*');
    if (error) { console.error('loadFilters error', error); return; }
    const buList = [...new Set((data||[]).map(r=>r.BU).filter(Boolean))].sort();
    const weekList = [...new Set((data||[]).map(r=>r.Weekly).filter(Boolean))].sort((a,b)=>a.localeCompare(b, undefined, {numeric:true}));
    const typeList = [...new Set((data||[]).map(r=>r.Type).filter(Boolean))].sort();
    const teamList = [...new Set((data||[]).map(r=>r.Team).filter(Boolean))].sort();

    const setOptions = (id, arr) => {
      const sel = document.getElementById(id);
      sel.innerHTML = '<option value="">All</option>' + arr.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
    };
    setOptions('filter-bu', buList);
    setOptions('filter-weekly', weekList);
    setOptions('filter-type', typeList);
    setOptions('filter-team', teamList);
  } catch (e) {
    console.error('loadFilters exception', e);
  }
}

/* ---------- load KPI and chart ---------- */
async function loadKPIandChart(){
  try {
    const filters = getFiltersFromUI();
    lastQueryFilters = filters;

    let q = supabase.from('summary_scrap_weekly').select('*');
    if (filters.BU) q = q.eq('BU', filters.BU);
    if (filters.Weekly) q = q.eq('Weekly', filters.Weekly);
    if (filters.Type) q = q.eq('Type', filters.Type);
    if (filters.Team) q = q.eq('Team', filters.Team);

    const { data, error } = await q;
    if (error) { console.error('loadKPI error', error); return; }

    const arr = data || [];
    const totalQty = arr.reduce((s,r)=>s + Number(r.total_quantity || 0), 0);
    const totalWt = arr.reduce((s,r)=>s + Number(r.total_weight || 0), 0);
    const totalVal = arr.reduce((s,r)=>s + Number(r.total_value || 0), 0);
    const totalItems = arr.reduce((s,r)=>s + Number(r.total_items || 0), 0);

    // Add icons to KPI
    document.getElementById('kpi-quantity').innerHTML = `<span style="font-size:20px; margin-right:6px;">üì¶</span>${totalQty.toLocaleString()}`;
    document.getElementById('kpi-weight').innerHTML = `<span style="font-size:20px; margin-right:6px;">‚öñÔ∏è</span>${totalWt.toLocaleString()}`;
    document.getElementById('kpi-value').innerHTML = `<span style="font-size:20px; margin-right:6px;">üí∞</span>${totalVal.toLocaleString()}`;
    document.getElementById('kpi-item').innerHTML = `<span style="font-size:20px; margin-right:6px;">üè∑Ô∏è</span>${totalItems.toLocaleString()}`;

    const sorted = arr.slice().sort((a,b)=>String(a.Weekly).localeCompare(String(b.Weekly), undefined, {numeric:true}));
    drawChart(sorted);
  } catch(e){
    console.error('loadKPIandChart exception', e);
  }
}

/* ---------- drawChart ---------- */
function drawChart(data){
  const ctx = document.getElementById('chart').getContext('2d');
  const labels = data.map(r=>r.Weekly);
  const itemCount = data.map(r=>Number(r.total_items || 0));
  const weights = data.map(r=>Number(r.total_weight || 0));
  const values = data.map(r=>Number(r.total_value || 0));

  if (chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    data: {
      labels,
      datasets: [
        { type:'bar', label:'Item Count', data:itemCount, backgroundColor:'#4caf50' },
        { type:'bar', label:'Sum Weight', data:weights, backgroundColor:'#2196f3' },
        { type:'line', label:'Value', data:values, borderColor:'#ff5722', yAxisID:'y1', tension:0.2, fill:false }
      ]
    },
    options: {
      responsive:true,
      interaction:{ mode:'index', intersect:false },
      scales: {
        y: { beginAtZero:true, title:{display:true, text:'Count / Weight'} },
        y1: { position:'right', title:{display:true, text:'Value'}, grid:{ drawOnChartArea:false } }
      }
    }
  });
}

/* ---------- load Detail (full columns) ---------- */
async function loadDetail(exportAll = false){
  try {
    const filters = getFiltersFromUI();
    lastQueryFilters = filters;
    const fromInput = parseInt(document.getElementById('input-from').value || '1', 10);
    const pageSize = parseInt(document.getElementById('page-size').value || '50', 10);

    let from = Math.max(0, (fromInput - 1));
    let to = from + pageSize - 1;
    if (exportAll) { from = 0; to = 999999; } // TƒÉng gi·ªõi h·∫°n cho export all

    let q = supabase.from('Detail_Scrap_Data').select('*', { count: 'exact' }).range(from, to);
    if (filters.BU) q = q.eq('BU', filters.BU);
    if (filters.Weekly) q = q.eq('Weekly', filters.Weekly);
    if (filters.Type) q = q.eq('Type', filters.Type);
    if (filters.Team) q = q.eq('Team_deliver', filters.Team);

    const { data, count, error } = await q;
    if (error) { console.error('loadDetail error', error); return null; }

    currentCount = count || 0;

    // L∆∞u tr·ªØ d·ªØ li·ªáu trang hi·ªán t·∫°i ƒë·ªÉ export
    if (!exportAll) {
      currentPageData = data || [];
    }

    // L·∫•y danh s√°ch c·ªôt ƒë·ªông (t·ª± ƒë·ªông theo d·ªØ li·ªáu)
    const allCols = data && data.length > 0 ? Object.keys(data[0]) : ["No data"];
    const thead = `<tr>${allCols.map(c=>`<th>${escapeHtml(c)}</th>`).join('')}</tr>`;

    if (!exportAll) {
      const tbody = data ? data.map(r => `<tr>${allCols.map(c=>`<td>${escapeHtml(r[c])}</td>`).join('')}</tr>`).join('') : '';
      document.querySelector(".table-wrap thead").innerHTML = thead;
      document.getElementById('detail-body').innerHTML = tbody || '<tr><td colspan="100%">No rows</td></tr>';

      const startRow = count ? (from + 1) : 0;
      const endRow = Math.min(to + 1, count || 0);
      document.getElementById('page-info').innerText = `Rows ${startRow} - ${endRow} / ${count || 0}`;

      document.getElementById('btn-prev').disabled = from <= 0;
      document.getElementById('btn-next').disabled = (to + 1) >= (count || 0);
      
      return data; // Tr·∫£ v·ªÅ d·ªØ li·ªáu
    } else {
      return data; // Tr·∫£ v·ªÅ d·ªØ li·ªáu cho export all
    }
  } catch (e) {
    console.error('loadDetail exception', e);
    return null;
  }
}

/* ---------- Load All Data for Export (v∆∞·ª£t qua gi·ªõi h·∫°n 1000 rows) ---------- */
async function loadAllDataForExport() {
  try {
    const filters = getFiltersFromUI();
    let allData = [];
    let start = 0;
    const limit = 1000;
    let hasMore = true;

    while (hasMore) {
      let q = supabase
        .from('Detail_Scrap_Data')
        .select('*')
        .range(start, start + limit - 1);
      
      if (filters.BU) q = q.eq('BU', filters.BU);
      if (filters.Weekly) q = q.eq('Weekly', filters.Weekly);
      if (filters.Type) q = q.eq('Type', filters.Type);
      if (filters.Team) q = q.eq('Team_deliver', filters.Team);

      const { data, error, count } = await q;
      
      if (error) {
        console.error('loadAllDataForExport error', error);
        break;
      }
      
      if (!data || data.length === 0) {
        hasMore = false;
        break;
      }
      
      allData = [...allData, ...data];
      start += limit;
      
      // Hi·ªÉn th·ªã ti·∫øn tr√¨nh
      console.log(`ƒê√£ t·∫£i ${allData.length} b·∫£n ghi...`);
      
      // N·∫øu nh·∫≠n ƒë∆∞·ª£c √≠t h∆°n limit, c√≥ nghƒ©a l√† ƒë√£ h·∫øt d·ªØ li·ªáu
      if (data.length < limit) {
        hasMore = false;
      }
    }
    
    console.log(`T·ªïng s·ªë b·∫£n ghi ƒë√£ t·∫£i: ${allData.length}`);
    return allData;
  } catch (e) {
    console.error('loadAllDataForExport exception', e);
    return [];
  }
}

/* ---------- Export Data ---------- */
async function exportData(all = false) {
  try {
    // Hi·ªÉn th·ªã th√¥ng b√°o ƒëang x·ª≠ l√Ω
    const exportBtn = all ? document.getElementById('btn-export-all') : document.getElementById('btn-export-page');
    const originalText = exportBtn.textContent;
    exportBtn.textContent = all ? '‚è≥ Loading...' : '‚è≥ Exporting...';
    exportBtn.disabled = true;
    
    let data;
    
    if (all) {
      // Export All - s·ª≠ d·ª•ng h√†m m·ªõi ƒë·ªÉ l·∫•y t·∫•t c·∫£ d·ªØ li·ªáu
      alert('ƒêang t·∫£i t·∫•t c·∫£ d·ªØ li·ªáu, vui l√≤ng ch·ªù...');
      data = await loadAllDataForExport();
    } else {
      // Export Page - s·ª≠ d·ª•ng d·ªØ li·ªáu trang hi·ªán t·∫°i
      data = currentPageData;
    }
    
    // Kh√¥i ph·ª•c tr·∫°ng th√°i button
    exportBtn.textContent = originalText;
    exportBtn.disabled = false;
    
    if (!data || data.length === 0) {
      alert("No data to export");
      return;
    }
    
    // T·∫°o file Excel
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Scrap_Data");
    const filename = all ? `Scrap_Data_All_${new Date().toISOString().split('T')[0]}.xlsx` : `Scrap_Data_Page_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, filename);
    
    if (all) {
      alert(`ƒê√£ xu·∫•t th√†nh c√¥ng ${data.length} b·∫£n ghi!`);
    }
  } catch (e) {
    console.error('exportData error', e);
    alert('Export failed. Check console.');
    
    // Kh√¥i ph·ª•c tr·∫°ng th√°i button n·∫øu c√≥ l·ªói
    const exportBtn = all ? document.getElementById('btn-export-all') : document.getElementById('btn-export-page');
    exportBtn.textContent = all ? 'üì¶ Export All' : 'üìÑ Export Page';
    exportBtn.disabled = false;
  }
}

/* ---------- Prev/Next ---------- */
document.getElementById('btn-prev').addEventListener('click', () => {
  const pageSize = parseInt(document.getElementById('page-size').value || '50', 10);
  let fromRow = Math.max(1, parseInt(document.getElementById('input-from').value || '1',10));
  fromRow = Math.max(1, fromRow - pageSize);
  document.getElementById('input-from').value = fromRow;
  loadDetail();
});

document.getElementById('btn-next').addEventListener('click', () => {
  const pageSize = parseInt(document.getElementById('page-size').value || '50', 10);
  let fromRow = Math.max(1, parseInt(document.getElementById('input-from').value || '1',10));
  fromRow = fromRow + pageSize;
  if (fromRow > currentCount) fromRow = Math.max(1, currentCount - pageSize + 1);
  document.getElementById('input-from').value = fromRow;
  loadDetail();
});

/* ---------- Apply / Reset ---------- */
document.getElementById('btn-apply').addEventListener('click', async () => {
  document.getElementById('input-from').value = 1;
  await loadKPIandChart();
  await loadDetail();
});
document.getElementById('btn-reset').addEventListener('click', async () => {
  document.getElementById('filter-bu').value = '';
  document.getElementById('filter-weekly').value = '';
  document.getElementById('filter-type').value = '';
  document.getElementById('filter-team').value = '';
  document.getElementById('input-from').value = 1;
  document.getElementById('page-size').value = '50';
  await loadKPIandChart();
  await loadDetail();
});

/* ---------- Export Buttons ---------- */
document.getElementById("btn-export-page").addEventListener("click", () => exportData(false));
document.getElementById("btn-export-all").addEventListener("click", () => exportData(true));

/* ---------- Initial load ---------- */
await loadFilters();
await loadKPIandChart();
await loadDetail();
</script>
</body>
</html>
