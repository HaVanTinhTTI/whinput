<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>K2_Master Data Editor</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
   /* ===== RESET CHUNG ===== */
body {
  font-family: Arial, sans-serif;
  background: #f5f5f5;
  margin: 0;
  padding: 20px;
}

/* ===== KHUNG TOOLBAR & FILTER ===== */
.filter-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
  background: #ffffff;
  padding: 12px 15px;
  margin-bottom: 10px;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
}

.filter-bar label {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 13px;
  font-weight: 500;
}

.filter-bar input, 
.filter-bar select {
  padding: 5px 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
  width: 150px;
  background: #fff;
}

.filter-bar button {
  background: #007bff;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s ease;
}
.filter-bar button:hover {
  background: #0056b3;
}

#spinner { display: none; }
.ok { color: green; }
.error { color: red; font-weight: bold; }

/* ===== TOOLBAR PH·ª§ ===== */
.toolbar {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
  margin-bottom: 10px;
}

button {
  background: #007bff;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
}
button:hover { background: #0056b3; }

input, select {
  padding: 5px 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

/* ===== B·∫¢NG CH√çNH ===== */
.table-container {
  width: fit-content;      /* ‚úÖ M·ªü r·ªông theo n·ªôi dung */
  max-width: 100%;         /* Gi·ªõi h·∫°n trong v√πng hi·ªÉn th·ªã */
  overflow-x: auto;        /* Ch·ªâ cu·ªôn ngang khi c·∫ßn */
  overflow-y: visible;     /* Cho ph√©p header sticky */
  border-radius: 10px;
  background: white;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  border: 1px solid #ddd;
}

/* ===== B·∫¢NG ===== */
#dataTable {
  border-collapse: collapse;
  font-size: 13px;
  table-layout: auto !important; /* ‚úÖ Auto-fit c·ªôt */
  width: auto;                   /* ‚úÖ Co gi√£n ƒë√∫ng n·ªôi dung */
  min-width: 100%;
}

/* ===== HEADER (C·ªê ƒê·ªäNH) ===== */
#dataTable th {
  position: sticky;
  top: 0;
  background: #f8f9fa;
  border-bottom: 2px solid #ccc;
  box-shadow: 0 2px 3px rgba(0,0,0,0.08);
  z-index: 5;
  text-align: left;
  padding: 6px 10px;
  white-space: nowrap;
  font-weight: 600;
}

/* ===== D·ªÆ LI·ªÜU TRONG √î ===== */
#dataTable td {
  padding: 6px 10px;
  border: 1px solid #ddd;
  text-align: left;
  background: white;
  vertical-align: middle;

  /* ‚úÖ Cho ph√©p t·ª± gi√£n v√† xu·ªëng d√≤ng khi c·∫ßn */
  white-space: normal;
  word-break: break-word;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 500px; /* Kh√¥ng cho c·ªôt qu√° d√†i */
}

/* ===== HOVER D√íNG ===== */
#dataTable tbody tr:hover {
  background: #f6faff;
}

/* ===== √î C√ì TH·ªÇ CH·ªàNH S·ª¨A ===== */
#dataTable td[contenteditable="true"] {
  background: #fff8dc;
  outline: none;
}

/* ===== THANH CU·ªòN TU·ª≤ CH·ªàNH ===== */
.table-container::-webkit-scrollbar {
  height: 8px;
  width: 8px;
}
.table-container::-webkit-scrollbar-thumb {
  background: #ccc;
  border-radius: 5px;
}

/* ===== SIDEBAR CH·ªåN C·ªòT ===== */
.sidebar {
  position: fixed;
  top: 0;
  right: 0;
  width: 260px;
  height: 100vh;
  background: #ffffff;
  border-left: 1px solid #ddd;
  box-shadow: -2px 0 6px rgba(0,0,0,0.1);
  padding: 15px;
  overflow-y: auto;
  transform: translateX(100%);
  transition: transform 0.3s ease;
  z-index: 9999;
}
.sidebar.open { transform: translateX(0); }

.sidebar h3 {
  margin-top: 0;
  color: #007bff;
  font-size: 16px;
  text-align: center;
  border-bottom: 1px solid #ccc;
  padding-bottom: 10px;
}

.sidebar label {
  display: block;
  padding: 6px 8px;
  border-radius: 4px;
  cursor: pointer;
}
.sidebar label:hover { background: #f0f4ff; }
.sidebar input[type="checkbox"] { margin-right: 6px; }

/* ===== THANH PH√ÇN TRANG ===== */
.pagination-bar {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 10px;
  margin-top: 10px;
  padding: 8px 12px;
  background: #ffffff;
  border-top: 1px solid #ddd;
  border-radius: 0 0 10px 10px;
  position: sticky;
  bottom: 0;
  z-index: 10;
}

.pagination-bar button {
  background: #007bff;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 5px 12px;
  font-size: 13px;
  cursor: poi
.sidebar {
  transition: transform 0.3s ease, opacity 0.3s ease;
  opacity: 0;
}
.sidebar.open {
  transform: translateX(0);
  opacity: 1;
}

#status {
  transition: opacity 0.4s ease;
  opacity: 0;
  font-weight: bold;
}
.ok { color: green; }
.error { color: red; }

.col-search {
  position: sticky;
  top: 0;
  background: #fff;
  padding-bottom: 8px;
  margin-bottom: 8px;
  border-bottom: 1px solid #eee;
  z-index: 1;
}

#columnSearch {
  width: 100%;
  padding: 6px 8px;
  border: 1px solid #ccc;
  border-radius: 6px;
  outline: none;
}

#columnSearch:focus {
  border-color: #007bff;
  box-shadow: 0 0 0 2px rgba(0,123,255,.15);
}

#columnCount {
  display: inline-block;
  margin-top: 6px;
  color: #666;
  font-size: 12px;
}

.filter-builder {
  background: #fff;
  border-radius: 8px;
  padding: 15px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  max-width: 600px;
  margin: 10px auto;
}

.filter-row {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 8px;
}

.filter-row select, .filter-row input {
  padding: 4px 6px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.filter-row .remove-row {
  background: #ff4d4f;
  color: white;
  border: none;
  border-radius: 4px;
  padding: 4px 8px;
  cursor: pointer;
}

  </style>
</head>
<body>


<!-- ===== B·ªò L·ªåC D·ªÆ LI·ªÜU ===== -->
<!-- ===== B·ªò L·ªåC D·ªÆ LI·ªÜU (N√ÇNG C·∫§P DROP-DOWN) ===== -->

<div class="filter-bar">
  <label>üß© Type Scrap:
    <input id="filterTypeScrap" list="listTypeScrap" placeholder="Nh·∫≠p ho·∫∑c ch·ªçn..." />
    <datalist id="listTypeScrap"></datalist>
  </label>
  <label>üìÑ Status:
    <input id="filterStatus" list="listStatus" placeholder="Nh·∫≠p ho·∫∑c ch·ªçn..." />
    <datalist id="listStatus"></datalist>
  </label>
  <label>üßæ Form No:
    <input id="filterFormNo" list="listFormNo" placeholder="Nh·∫≠p ho·∫∑c ch·ªçn..." />
    <datalist id="listFormNo"></datalist>
  </label>
  <label>üîç ItemCode:
    <input id="filterItemCode" list="listItemCode" placeholder="Nh·∫≠p ho·∫∑c ch·ªçn..." />
    <datalist id="listItemCode"></datalist>
  </label>
  <button id="applyFilterBtn">üîé L·ªçc</button>
  <button id="resetFilterBtn">‚ôªÔ∏è Reset</button>
  <button id="addMainFilterBtn">‚ûï Th√™m ƒëi·ªÅu ki·ªán</button>

  <button id="loadBtn">üîÑ T·∫£i d·ªØ li·ªáu</button>
    <button id="saveBtn">üíæ L∆∞u thay ƒë·ªïi</button>
    <button id="exportBtn">‚¨áÔ∏è Xu·∫•t Excel</button>
    <button id="toggleColumnsBtn">‚öôÔ∏è Ch·ªçn c·ªôt</button>
	<button id="applyToAllBtn">üìã Apply to all rows</button>
    <span id="spinner">‚è≥ ƒêang t·∫£i...</span>
	
</div>


  



<!-- ‚öôÔ∏è SIDEBAR CH·ªåN C·ªòT -->

<div id="columnsPanel" class="sidebar">
  <h3>Hi·ªÉn th·ªã c·ªôt</h3>

  <!-- üîé T√¨m nhanh t√™n c·ªôt -->
  <div class="col-search">
    <input id="columnSearch" type="text" placeholder="T√¨m t√™n c·ªôt..." />
    <small id="columnCount"></small>
  </div>

  <div id="columnsList"></div>
</div>

<div id="extraFilters" style="display:flex;flex-wrap:wrap;gap:10px;margin:10px 0;"></div>








<div class="table-container" style="overflow:auto; max-height:75vh;">
  <table id="dataTable">
	
  
  
    <thead><tr id="tableHead"></tr></thead>
	
	
    <tbody></tbody>
	

  </table>
  
</div>
<div class="pagination-bar" style="justify-content:center; margin-top:10px;">
  <button id="prevPage">‚¨ÖÔ∏è Tr∆∞·ªõc</button>
  <span id="pageInfo">Trang 1/1</span>
  <button id="nextPage">‚û°Ô∏è Sau</button>
  <span style="margin-left:20px;">S·ªë d√≤ng/trang:</span>
  <select id="pageSizeSelect">
    <option value="25">25</option>
    <option value="50" selected>50</option>
    <option value="100">100</option>
    <option value="200">200</option>
	<option value="200">500</option>
	
  </select>
  <p id="status"></p>
</div>


</div>

<script>
const client = supabase.createClient(
  'https://chjqassbtcqthueeddou.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoanFhc3NidGNxdGh1ZWVkZG91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMzY2OTgsImV4cCI6MjA3NTcxMjY5OH0.FbWGSw9sqUkb2_ppErN4QTFGy1Cho-HX4XbR5_-KB0I'
);

const allColumns = [
   "EHS_Classification_waste", "EHS_Type", "EHS_VN_description",
  "ID", "Item Reference No.", "ItemCode", "ItemSystemDesc", "ItemType",
  "MRDetailID", "MRRequestID", "OrgName", "Quantity", "Remaining Qty", "Revision",
  "UOM", "approve_time", "batch_scrap", "created_at", "eForm Process Status",
  "form_no", "from_sub", "locator_from", "lot", "org", "pack_by", "pack_time",
  "pallet_id", "pallet_seq", "printed_at", "printed_by", "putaway_by", "putaway_time",
  "qty_receipt", "receipt_date_time", "received_by", "scrap_by", "scrap_time",
  "scrap_time_custom", "status", "submit_K2_time", "team", "type_scrap","box_id", 
"id", 
"last_pack_at", 
"last_pack_by", 
"last_pack_time", 
"price_unit", 
"qty_open_pack", 
"qty_pack", 
"total_cost", 
"total_weight", 
"weight_unit"

];

let visibleCols = [
	"org",
	"form_no",
	"ItemCode",
  "Quantity",
  "qty_receipt",
  "status"


			];
let currentData = [];


let pageSize = 50;   // s·ªë d√≤ng m·ªói trang m·∫∑c ƒë·ªãnh
let totalCount = 0; // ‚úÖ T·ªïng s·ªë d√≤ng tr√™n server

let currentPage = 1; // trang hi·ªán t·∫°i
let totalPages = 1;

let currentFilters = {}; // ‚úÖ L∆∞u l·∫°i filter hi·ªán t·∫°i ƒë·ªÉ d√πng khi chuy·ªÉn trang


let currentSort = { column: null, asc: true };


function $(id){ return document.getElementById(id); }
function showStatus(msg,ok=true){ $('status').textContent=msg; $('status').className=ok?'ok':'error'; }

// ===== Toggle columns UI =====
// ===== T·∫°o danh s√°ch checkbox =====


let sidebarTimer = null;

$('toggleColumnsBtn').addEventListener('click', () => {
  const panel = $('columnsPanel');

  // ‚úÖ M·ªü ngay l·∫≠p t·ª©c
  if (!panel.classList.contains('open')) {
    panel.classList.add('open');
    startSidebarTimer(); // b·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c ƒë·ªÉ ·∫©n
  } else {
    panel.classList.remove('open'); // click l·∫ßn 2 th√¨ ƒë√≥ng ngay
    clearTimeout(sidebarTimer);
  }
});

function startSidebarTimer() {
  clearTimeout(sidebarTimer);
  sidebarTimer = setTimeout(() => {
    $('columnsPanel').classList.remove('open');
  }, 1500); // ·∫©n sau 1.5 gi√¢y n·∫øu kh√¥ng di chu·ªôt v√†o
}

// üß† Khi r√™ chu·ªôt v√†o => t·∫°m d·ª´ng auto-hide
$('columnsPanel').addEventListener('mouseenter', () => {
  clearTimeout(sidebarTimer);
});

// üß† Khi r·ªùi chu·ªôt => b·∫Øt ƒë·∫ßu ƒë·∫øm l·∫°i 1.5 gi√¢y ƒë·ªÉ ·∫©n
$('columnsPanel').addEventListener('mouseleave', () => {
  startSidebarTimer();
});



////t·∫£i trang
$('nextPage').addEventListener('click', () => {
  if (currentPage < totalPages) loadPagedData(currentPage + 1, currentFilters);
});
$('prevPage').addEventListener('click', () => {
  if (currentPage > 1) loadPagedData(currentPage - 1, currentFilters);
});


$('pageSizeSelect').addEventListener('change', e=>{
  pageSize = parseInt(e.target.value,10);
  currentPage = 1;
  renderTable(currentData);
});



// --- Utils: b·ªè d·∫•u + lower-case ƒë·ªÉ so kh·ªõp linh ho·∫°t
function slugify(str) {
  return String(str || '')
    .normalize('NFD')               // t√°ch d·∫•u
    .replace(/[\u0300-\u036f]/g, '')// b·ªè d·∫•u
    .toLowerCase()
    .trim();
}

const colListDiv = $('columnsList');
const columnSearchInput = $('columnSearch');
const columnCountEl = $('columnCount');

function buildColumnsList() {
  colListDiv.innerHTML = '';
  // t·∫°o DOM 1 l·∫ßn, g·∫Øn data-name ƒë·ªÉ l·ªçc nhanh
  allColumns.forEach(col => {
    const id = 'col_' + col.replace(/\W/g, '_');
    const lbl = document.createElement('label');
    lbl.dataset.name = col; // gi·ªØ t√™n g·ªëc ƒë·ªÉ filter
    const checked = visibleCols.includes(col) ? 'checked' : '';
    lbl.innerHTML = `
      <input type="checkbox" id="${id}" ${checked}>
      ${col}
    `;

    lbl.querySelector('input').addEventListener('change', (e) => {
      if (e.target.checked) {
        if (!visibleCols.includes(col)) visibleCols.push(col);
      } else {
        visibleCols = visibleCols.filter(c => c !== col);
      }
      renderTable(currentData);
      updateColumnCount(); // c·∫≠p nh·∫≠t ƒë·∫øm sau khi ·∫©n/hi·ªán
    });

    colListDiv.appendChild(lbl);
  });

  updateColumnCount();
}

// filter theo input
function filterColumnsList() {
  const q = slugify(columnSearchInput.value);
  const labels = colListDiv.querySelectorAll('label');
  let visible = 0;

  labels.forEach(lbl => {
    const name = lbl.dataset.name || '';
    const match = slugify(name).includes(q);
    lbl.style.display = match ? '' : 'none';
    if (match) visible++;
  });

  updateColumnCount(visible);
}

function updateColumnCount(visibleOverride) {
  const total = allColumns.length;
  const visible = (typeof visibleOverride === 'number')
    ? visibleOverride
    : [...colListDiv.querySelectorAll('label')].filter(l => l.style.display !== 'none').length;

  columnCountEl.textContent = `Hi·ªÉn th·ªã ${visible}/${total} c·ªôt`;
}

// Debounce nh·ªè ƒë·ªÉ c·∫£m gi√°c m∆∞·ª£t (nh∆∞ng hi·ªÉn th·ªã g·∫ßn nh∆∞ t·ª©c th√¨)
let searchTimer = null;
columnSearchInput.addEventListener('input', () => {
  if (searchTimer) clearTimeout(searchTimer);
  searchTimer = setTimeout(filterColumnsList, 120);
});

// Kh·ªüi t·∫°o danh s√°ch c·ªôt l√∫c load
buildColumnsList();

// ===== Load data =====

async function loadPagedData(page = 1, filters = {}) {

  $('spinner').style.display = 'inline';

  const from = (page - 1) * pageSize;
  const to = page * pageSize - 1;

  const escapedCols = allColumns.map(c => /[\s\.]/.test(c) ? `"${c}"` : c);

  let q = client
    .from('K2_Master')
    .select(escapedCols.join(','), { count: 'exact' })
	.order('ItemCode', { ascending: true }) // s·∫Øp theo ItemCode ngay t·ª´ DB n·∫øu ƒë∆∞·ª£c
    .order('created_at', { ascending: false })
    .range(from, to); // ‚úÖ Ch·ªâ l·∫•y ƒë√∫ng ph·∫°m vi c·ªßa trang hi·ªán t·∫°i

  // üß© L·ªçc (n·∫øu c√≥)
  if (filters.type_scrap) q = q.ilike('type_scrap', `%${filters.type_scrap}%`);
  if (filters.status) q = q.ilike('status', `%${filters.status}%`);
  if (filters.form_no) q = q.ilike('form_no', `%${filters.form_no}%`);
  if (filters.ItemCode) q = q.ilike('ItemCode', `%${filters.ItemCode}%`);

  const { data, count, error } = await q;

  $('spinner').style.display = 'none';
  if (error) {
    showStatus('‚ùå L·ªói t·∫£i: ' + error.message, false);
    return;
  }

  currentData = data;
  totalCount = count || 0;                  // ‚úÖ l∆∞u t·ªïng s·ªë d√≤ng
totalPages = Math.ceil(totalCount / pageSize); // ‚úÖ t√≠nh t·ªïng s·ªë trang

  totalPages = Math.ceil(count / pageSize);
  currentPage = page;

  renderTable(currentData);
  updatePagination();
  showStatus(`‚úÖ Trang ${currentPage}/${totalPages} ‚Äî ${data.length} d√≤ng`);
}


// üß© Helper: unique values
function getUniqueValues(rows, field) {
  return [...new Set(rows.map(r => r[field]).filter(v => v))].sort();
}

async function loadDropdownOptionsFull() {
  const { data, error } = await client
    .from('K2_Master')
    .select('type_scrap, status, form_no, ItemCode');
  if (error) {
    console.error(error);
    return;
  }

  const getUnique = (arr, key) =>
    [...new Set(arr.map(r => r[key]).filter(Boolean))].sort();

  fillList('listTypeScrap', getUnique(data, 'type_scrap'));
  fillList('listStatus', getUnique(data, 'status'));
  fillList('listFormNo', getUnique(data, 'form_no'));
  fillList('listItemCode', getUnique(data, 'ItemCode'));
}



// üß© C·∫≠p nh·∫≠t datalist theo dataset hi·ªán t·∫°i
function updateDropdownOptions(dataset) {
  fillList('listTypeScrap', getUniqueValues(dataset, 'type_scrap'));
  fillList('listStatus',    getUniqueValues(dataset, 'status'));
  fillList('listFormNo',    getUniqueValues(dataset, 'form_no'));
  fillList('listItemCode',  getUniqueValues(dataset, 'ItemCode'));
}

function fillList(id, values) {
  const dl = $(id);
  const sorted = [...values]
    .map(v => String(v || '').trim())
    .filter(v => v)
    .sort((a, b) => a.localeCompare(b, 'vi', { sensitivity: 'base' })); // s·∫Øp theo anpha ti·∫øng Vi·ªát n·∫øu c√≥ d·∫•u
  dl.innerHTML = sorted.map(v => `<option value="${v}">`).join('');
}


// ü™ù G√°n s·ª± ki·ªán 1 l·∫ßn ƒë·ªÉ r√∫t g·ªçn g·ª£i √Ω theo nh·ªØng g√¨ ƒëang g√µ
(function bindFilterInputsOnce(){
  function onFilterTyping() {
    const f1 = $('filterTypeScrap').value.trim().toLowerCase();
    const f2 = $('filterStatus').value.trim().toLowerCase();
    const f3 = $('filterFormNo').value.trim().toLowerCase();
    const f4 = $('filterItemCode').value.trim().toLowerCase();

    let temp = [...currentData]; // d·ª±a tr√™n dataset hi·ªán h·ªØu tr√™n UI
    if (f1) temp = temp.filter(r => String(r.type_scrap || '').toLowerCase().includes(f1));
    if (f2) temp = temp.filter(r => String(r.status || '').toLowerCase().includes(f2));
    if (f3) temp = temp.filter(r => String(r.form_no || '').toLowerCase().includes(f3));
    if (f4) temp = temp.filter(r => String(r.ItemCode || '').toLowerCase().includes(f4));

    updateDropdownOptions(temp); // r√∫t g·ªçn suggestion
  }
  ['filterTypeScrap','filterStatus','filterFormNo','filterItemCode'].forEach(id=>{
    $(id).addEventListener('input', onFilterTyping);
    $(id).addEventListener('change', onFilterTyping);
  });
})();


// ===== Render table =====
function renderTable(rows) {
  const head = $("tableHead");
  head.innerHTML = "";
  visibleCols.forEach((c) => {
    const th = document.createElement("th");
    th.textContent = c.toUpperCase();
    th.style.cursor = "pointer";
    th.title = "Nh·∫•n ƒë·ªÉ s·∫Øp x·∫øp";

    th.addEventListener("click", () => {
      if (currentSort.column === c) currentSort.asc = !currentSort.asc;
      else currentSort = { column: c, asc: true };

      currentData.sort((a, b) => {
        let valA = a[c];
        let valB = b[c];

        const isNumA = /^-?\d+(\.\d+)?$/.test(valA);
        const isNumB = /^-?\d+(\.\d+)?$/.test(valB);
        if (isNumA && isNumB) {
          valA = Number(valA);
          valB = Number(valB);
          return currentSort.asc ? valA - valB : valB - valA;
        }
        return currentSort.asc
          ? String(valA || "").localeCompare(String(valB || ""))
          : String(valB || "").localeCompare(String(valA || ""));
      });

      renderTable(currentData);
    });
		
    if (currentSort.column === c) {
      th.textContent += currentSort.asc ? " ‚ñ≤" : " ‚ñº";
    }
    head.appendChild(th);
  });

  const body = $("dataTable").querySelector("tbody");
  body.innerHTML = "";
rows.forEach((r, i) => {
  const tr = document.createElement("tr");
  visibleCols.forEach((col) => {
    const td = document.createElement("td");
    let val = r[col];

    if (typeof val === "string" && /^-?\d+(\.\d+)?$/.test(val.trim()))
      val = Number(val);
    if (val === null || val === undefined) val = "";

    // ‚úÖ N·∫øu l√† c·ªôt ng√†y th√¨ hi·ªÉn th·ªã l·ªãch (date picker)
  // ‚úÖ N·∫øu l√† c·ªôt ng√†y th√¨ hi·ªÉn th·ªã l·ªãch (date picker)
if (["created_at", "approve_time", "SubmittedDate", "CompletedDate"].includes(col)) {
  const input = document.createElement("input");
  input.type = "date";
  input.value = val
    ? new Date(val).toISOString().split("T")[0]
    : new Date().toISOString().split("T")[0];
  input.style.width = "140px";
  input.dataset.row = i;
  input.dataset.col = col;

  input.addEventListener("change", (e) => {
    const rowIndex = e.target.dataset.row;
    const field = e.target.dataset.col;
    const newVal = e.target.value;
    currentData[rowIndex][field] = newVal; // ‚úÖ C·∫≠p nh·∫≠t t·∫°m
    td.dataset.updated = true;
    td.style.background = "#fff8dc"; // ƒë·ªïi m√†u khi ch·ªânh
  });

  td.textContent = "";
  td.appendChild(input);
}

	
	
	else {
      // ‚úÖ C·ªôt kh√°c th√¨ gi·ªØ d·∫°ng contentEditable b√¨nh th∆∞·ªùng
      td.textContent = val;
      td.contentEditable = true;
      td.dataset.row = i;
      td.dataset.col = col;
    }

    tr.appendChild(td);
  });
  body.appendChild(tr);
});



  updatePagination();
}


// ===== APPLY TO ALL ROWS =====
// ===== APPLY TO ALL ROWS (NH·∫¨N C·∫¢ INPUT & DATE FIELD) =====
// ===== APPLY TO ALL ROWS (C·∫¢ √î V√Ä INPUT NG√ÄY) =====
let lastClickedCell = null;

// üß© Ghi nh·ªõ √¥ ƒë∆∞·ª£c click ho·∫∑c focus
document.addEventListener("focusin", (e) => {
  const td = e.target.closest("td");
  if (td && td.dataset.col) {
    lastClickedCell = td;
  }
});
document.addEventListener("click", (e) => {
  const td = e.target.closest("td");
  if (td && td.dataset.col) {
    lastClickedCell = td;
  }
});

$('applyToAllBtn').addEventListener('click', () => {
  const cell = lastClickedCell;
  if (!cell) {
    showStatus('‚ö†Ô∏è Ch·ªçn 1 √¥ ho·∫∑c input b·∫•t k·ª≥ tr∆∞·ªõc khi d√πng Apply to all rows', false);
    return;
  }

  const col = cell.dataset.col;
  let val = '';

  // N·∫øu l√† input date th√¨ l·∫•y value, c√≤n contenteditable th√¨ l·∫•y text
  const input = cell.querySelector('input');
  if (input) val = input.value.trim();
  else val = cell.textContent.trim();

  if (!val) {
    showStatus('‚ö†Ô∏è Kh√¥ng th·ªÉ √°p d·ª•ng gi√° tr·ªã tr·ªëng', false);
    return;
  }

  if (!confirm(`√Åp d·ª•ng gi√° tr·ªã "${val}" cho to√†n b·ªô c·ªôt ${col.toUpperCase()}?`)) return;

  // ‚úÖ √Åp d·ª•ng v√†o to√†n b·ªô c·ªôt (bao g·ªìm input ho·∫∑c text)
  document.querySelectorAll(`td[data-col="${col}"]`).forEach(td => {
    const inp = td.querySelector('input');
    if (inp) inp.value = val;
    else td.textContent = val;

    td.dataset.updated = true;
    td.style.background = '#fff8dc';

    // ‚úÖ Ghi nh·∫≠n thay ƒë·ªïi v√†o edits ƒë·ªÉ khi Save s·∫Ω l∆∞u t·∫•t c·∫£
    const rowIndex = Number(td.dataset.row);
    const original = currentData[rowIndex];
    if (!original) return;

    const key = original.ID || JSON.stringify({
      OrgName: original.OrgName,
      ItemCode: original.ItemCode,
      "Item Reference No.": original["Item Reference No."],
      locator_from: original.locator_from,
      from_sub: original.from_sub,
      lot: original.lot
    });

    if (!edits.has(key)) edits.set(key, {});
    edits.get(key)[col] = val;
    currentData[rowIndex][col] = val; // ƒë·ªìng b·ªô local
  });

  showStatus(`‚úÖ ƒê√£ √°p d·ª•ng "${val}" cho to√†n b·ªô c·ªôt ${col} v√† ghi nh·∫≠n ƒë·ªÉ l∆∞u`, true);
});




///Hi·ªÉn th·ªã bao nhi√™u trang
function updatePagination() {
  $('pageInfo').textContent = `Trang ${currentPage}/${totalPages || 1} ‚Äî T·ªïng ${totalCount} d√≤ng`;

  $('prevPage').disabled = currentPage <= 1;
  $('nextPage').disabled = currentPage >= totalPages;
}



// ===== Track edits =====

// ===== TRACK CH·ªà C√ÅC √î THAY ƒê·ªîI =====
const edits = new Map();

document.addEventListener("focusin", (e) => {
  if (e.target.matches('td[contenteditable="true"]')) {
    e.target.dataset.oldValue = e.target.textContent.trim();
  }
});

document.addEventListener("input", (e) => {
  if (e.target.matches('td[contenteditable="true"]')) {
    const rowIndex = Number(e.target.dataset.row);
    const col = e.target.dataset.col;
    let val = e.target.textContent.trim();

    // √©p s·ªë n·∫øu c·∫ßn
    if (/^-?\d+(\.\d+)?$/.test(val)) val = Number(val);

    const original = currentData[rowIndex]; // ‚úÖ D√≤ng th·∫≠t trong currentData
    if (!original) return; // tr√°nh undefined

    // n·∫øu b·∫£ng c√≥ kh√≥a ph·ª©c h·ª£p, l·∫•y ra ƒë√∫ng c√°c field kh√≥a ch√≠nh
    const key = original.ID || JSON.stringify({
      OrgName: original.OrgName,
      ItemCode: original.ItemCode,
      "Item Reference No.": original["Item Reference No."],
      locator_from: original.locator_from,
      from_sub: original.from_sub,
      lot: original.lot
    });

    if (!edits.has(key)) edits.set(key, {});
    edits.get(key)[col] = val;
  }
});

// ===== L∆ØU L·∫†I √î CU·ªêI C√ôNG ƒê∆Ø·ª¢C CLICK HO·∫∂C FOCUS =====
//let lastClickedCell = null;

// üß© Khi click v√†o √¥ (ho·∫∑c input trong √¥), ghi nh·ªõ l·∫°i tr∆∞·ªõc khi m·∫•t focus
document.addEventListener("mousedown", (e) => {
  const td = e.target.closest("td");
  if (td && td.dataset.col) {
    lastClickedCell = td;
  }
});

// üß© Khi focus v√†o √¥ (v√≠ d·ª• d√πng Tab ho·∫∑c click v√†o input date)
document.addEventListener("focusin", (e) => {
  const td = e.target.closest("td");
  if (td && td.dataset.col) {
    lastClickedCell = td;
  }
});



// ===== SAVE CH·ªà D√íNG THAY ƒê·ªîI =====
$('saveBtn').addEventListener('click', async () => {
  if (edits.size === 0) {
    showStatus('‚ö†Ô∏è Kh√¥ng c√≥ thay ƒë·ªïi ƒë·ªÉ l∆∞u', false);
    return;
  }

  $('spinner').style.display = 'inline';

  const updates = [];
  edits.forEach((cols, key) => {
    let parsedKey;
    try {
      parsedKey = JSON.parse(key);
    } catch {
      parsedKey = null;
    }

    // N·∫øu l√† kh√≥a ph·ª©c h·ª£p (OrgName, ItemCode, ReferenceNo, locator_from, from_sub, lot)
    if (parsedKey) {
      updates.push({ ...cols, ...parsedKey });
    }
  });

  if (updates.length === 0) {
    $('spinner').style.display = 'none';
    showStatus('‚ö†Ô∏è Kh√¥ng c√≥ d√≤ng h·ª£p l·ªá ƒë·ªÉ l∆∞u (thi·∫øu kh√≥a ch√≠nh)', false);
    return;
  }

  let success = 0, fail = 0;
  const batchSize = 50;

  for (let i = 0; i < updates.length; i += batchSize) {
    const batch = updates.slice(i, i + batchSize);
    const { error } = await client
      .from('K2_Master')
      .upsert(batch, {
        onConflict: 'OrgName,ItemCode,"Item Reference No.",locator_from,from_sub,lot'
      });

    if (error) {
      fail += batch.length;
      console.error('‚ùå L·ªói Supabase:', error);
    } else {
      success += batch.length;
    }

    await new Promise(r => setTimeout(r, 100));
  }

 $('spinner').style.display = 'none';

// ‚úÖ N·∫øu c√≥ l·ªói th√¨ gi·ªØ l√¢u, n·∫øu kh√¥ng th√¨ t·ª± ·∫©n nhanh
if (fail > 0) {
  showStatus(`‚ö†Ô∏è L∆∞u xong: ${success} d√≤ng | L·ªói: ${fail}`, false);
} else {
  showStatus(`üíæ L∆∞u xong: ${success} d√≤ng`, true, 2000); // ‚úÖ t·ª± ·∫©n sau 2 gi√¢y
}

edits.clear();
//await loadPagedData(currentPage, currentFilters); // ‚úÖ reload l·∫°i trang hi·ªán t·∫°i

});

let statusTimer;

// ‚úÖ H√†m hi·ªÉn th·ªã tr·∫°ng th√°i (th√¥ng b√°o th√†nh c√¥ng ho·∫∑c l·ªói)
function showStatus(msg, ok = true, duration = 5000) {
  let el = document.getElementById('status');

  // N·∫øu ch∆∞a c√≥ ph·∫ßn t·ª≠ <p id="status"> th√¨ t·∫°o m·ªõi
  if (!el) {
    el = document.createElement('p');
    el.id = 'status';
    document.body.appendChild(el);
  }

  // Hi·ªÉn th·ªã th√¥ng b√°o
  el.textContent = msg;
  el.className = ok ? 'ok' : 'error';
  el.style.opacity = '1';
  el.style.transition = 'opacity 0.4s ease';
  el.style.fontWeight = 'bold';
  el.style.margin = '8px 0';
  el.style.fontSize = '13px';
  el.style.color = ok ? 'green' : 'red';

  // ‚úÖ N·∫øu l√† th√¥ng b√°o th√†nh c√¥ng th√¨ t·ª± ·∫©n sau v√†i gi√¢y
  if (ok) {
    clearTimeout(statusTimer);
    statusTimer = setTimeout(() => {
      el.style.opacity = '0';
    }, duration);
  }
  // ‚ùå N·∫øu l√† l·ªói th√¨ gi·ªØ nguy√™n cho ƒë·∫øn khi c√≥ h√†nh ƒë·ªông m·ªõi
}


// ===== Export Excel =====
$('exportBtn').addEventListener('click',()=>{
  if(!currentData.length) return showStatus('‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t',false);

  const exportData = currentData.slice(0, 5000); // ‚úÖ Gi·ªõi h·∫°n 5000 d√≤ng
  const filtered = exportData.map(row=>{
    const obj={};
    visibleCols.forEach(c=>obj[c]=row[c]??'');
    return obj;
  });

  const ws=XLSX.utils.json_to_sheet(filtered);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'K2_Master');
  XLSX.writeFile(wb,'K2_Master_export.xlsx');
  showStatus(`‚úÖ ƒê√£ xu·∫•t ${filtered.length} d√≤ng ra Excel!`);
});


$('applyFilterBtn').addEventListener('click', () => {
  if (!currentData.length) {
    showStatus('‚ö†Ô∏è Ch∆∞a c√≥ d·ªØ li·ªáu. B·∫•m "T·∫£i d·ªØ li·ªáu" tr∆∞·ªõc khi l·ªçc.', false);
    return;
  }

  const baseFilters = {
    type_scrap: $('filterTypeScrap').value.trim().toLowerCase(),
    status: $('filterStatus').value.trim().toLowerCase(),
    form_no: $('filterFormNo').value.trim().toLowerCase(),
    ItemCode: $('filterItemCode').value.trim().toLowerCase(),
  };

  const extraRows = [...document.querySelectorAll('#extraFilters label')];
  const extraFilters = extraRows.map(row => {
    const col = row.querySelector('select')?.value;
    const val = row.querySelector('input')?.value.trim().toLowerCase();
    return { col, val };
  }).filter(f => f.col && f.val);

  let filtered = currentData.filter(row => {
    const baseOK = Object.entries(baseFilters).every(([k, v]) =>
      !v || String(row[k] || '').toLowerCase().includes(v)
    );
    const extraOK = extraFilters.every(f =>
      String(row[f.col] || '').toLowerCase().includes(f.val)
    );
    return baseOK && extraOK;
  });

  renderTable(filtered);
  showStatus(`‚úÖ L·ªçc xong (${filtered.length} d√≤ng)`, true);
});






$('resetFilterBtn').addEventListener('click', () => {
  $('filterTypeScrap').value = '';
  $('filterStatus').value = '';
  $('filterFormNo').value = '';
  $('filterItemCode').value = '';
  currentFilters = {};
  renderTable(currentData); // hi·ªÉn th·ªã l·∫°i to√†n b·ªô data c√≥ s·∫µn
  showStatus('‚ôªÔ∏è ƒê√£ reset filter, hi·ªÉn th·ªã to√†n b·ªô d·ªØ li·ªáu hi·ªán c√≥', true);
});


// ===== Load data on button =====
$('loadBtn').addEventListener('click', () => loadPagedData(1));  // Gi·ªØ l·∫°i n√∫t t·∫£i th·ªß c√¥ng


// ===== üîç FILTER N√ÇNG CAO (Dynamic Filter Builder) =====




function createMainFilterRow() {
  const wrap = document.createElement('label');
  wrap.style.display = 'flex';
  wrap.style.alignItems = 'center';
  wrap.style.gap = '5px';
  wrap.style.background = '#fff';
  wrap.style.padding = '4px 6px';
  wrap.style.border = '1px solid #ccc';
  wrap.style.borderRadius = '6px';

  const colSel = document.createElement('select');
  colSel.style.padding = '4px';
  colSel.innerHTML = allColumns
    .map(c => `<option value="${c}">${c}</option>`).join('');

  const valInput = document.createElement('input');
  valInput.type = 'text';
  valInput.placeholder = 'Nh·∫≠p ho·∫∑c ch·ªçn...';
  valInput.style.padding = '4px';
  valInput.style.border = '1px solid #ccc';
  valInput.style.borderRadius = '4px';

  const listId = 'list_' + Math.random().toString(36).substring(2,9);
  valInput.setAttribute('list', listId);
  const datalist = document.createElement('datalist');
  datalist.id = listId;

  const removeBtn = document.createElement('button');
  removeBtn.textContent = '‚ùå';
  removeBtn.style.marginLeft = '4px';
  removeBtn.addEventListener('click', () => wrap.remove());

  wrap.append(colSel, valInput, datalist, removeBtn);

  // --- c·∫≠p nh·∫≠t g·ª£i √Ω unique theo currentData ---
 function updateDatalist() {
  const col = colSel.value;
  let filtered = [...currentData];
  // l·ªçc tr∆∞·ªõc theo c√°c filter hi·ªán c√≥
  document.querySelectorAll('#extraFilters label').forEach(lbl => {
    const c = lbl.querySelector('select')?.value;
    const v = lbl.querySelector('input')?.value.trim();
    if (!c || !v) return;
    filtered = filtered.filter(r => String(r[c]||'').toLowerCase().includes(v.toLowerCase()));
  });
  const uniqueVals = [...new Set(filtered.map(r => r[col]).filter(Boolean))].sort();
  datalist.innerHTML = uniqueVals.slice(0, 200).map(v => `<option value="${v}">`).join('');
}


  colSel.addEventListener('change', updateDatalist);
  updateDatalist();

  return wrap;
}





  // üî• G·ªçi h√†m ƒë·ªÉ kh·ªüi ƒë·ªông khi load trang

let lastCell = null;
document.getElementById('addMainFilterBtn').addEventListener('click', () => {
  const area = document.getElementById('extraFilters');
  area.appendChild(createMainFilterRow());
});

document.addEventListener('focusin', e => {
  if (e.target.matches('td[contenteditable="true"]')) lastCell = e.target;
});
document.addEventListener('click', e => {
  if (e.target.matches('td[contenteditable="true"]')) lastCell = e.target;
});

// ‚úÖ B·ªçc ph·∫ßn kh·ªüi ƒë·ªông trong h√†m async ƒë·ªÉ d√πng await h·ª£p l·ªá

 async function init() {
  await loadPagedData(1);           // ch·ªâ t·∫£i 1 l·∫ßn duy nh·∫•t
  updateDropdownOptions(currentData); // t·ª± t·∫°o datalist d·ª±a tr√™n data ƒë√£ c√≥

}

init();  // üî• G·ªçi h√†m ƒë·ªÉ kh·ªüi ƒë·ªông khi load trang

//initDynamicFilter(); // ‚úÖ G·ªåI TH√äM D√íNG N√ÄY



</script>
</body>
</html>
