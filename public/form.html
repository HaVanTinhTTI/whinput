
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Upload Inventory Excel to Supabase</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <h2>Upload Inventory Excel File</h2>
  <input type="file" id="excelFile" />
  <button onclick="uploadExcel()">Upload</button>

  <script>
    const supabaseUrl = 'https://chjqassbtcqthueeddou.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoanFhc3NidGNxdGh1ZWVkZG91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMzY2OTgsImV4cCI6MjA3NTcxMjY5OH0.FbWGSw9sqUkb2_ppErN4QTFGy1Cho-HX4XbR5_-KB0I';
    const client = supabase.createClient(supabaseUrl, supabaseKey);

    async function uploadExcel() {
      const file = document.getElementById('excelFile').files[0];
      if (!file) {
        alert('Vui lòng chọn file Excel trước khi upload.');
        return;
      }

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet, { defval: null });

          const mappedData = json.map(row => {
            const record = {
              seq: row['SEQ'],
              item_no: row['ITEM NO'],
              rev: row['REV.'],
              subinventory: row['SUBINVENTORY'],
              locator: row['LOCATOR'],
              on_hand: row['ON HAND'],
              uom: row['UOM'],
              site: row['Site'],
              demand: row['Demand']
            };
            if (row['LOT NUMBER'] !== null && row['LOT NUMBER'] !== undefined) {
              record.lot_number = row['LOT NUMBER'];
            }
            return record;
          });

          const { data: inserted, error } = await client
            .from('inventory_data')
            .insert(mappedData);

          if (error) {
            alert('Lỗi: ' + error.message);
            console.error(error);
          } else {
            alert('Upload thành công!');
            console.log(inserted);
          }
        } catch (err) {
          console.error('Lỗi xử lý file:', err);
          alert('Đã xảy ra lỗi khi xử lý file: ' + err.message);
        }
      };
      reader.readAsArrayBuffer(file);
    }
  </script>
</body>
</html>
